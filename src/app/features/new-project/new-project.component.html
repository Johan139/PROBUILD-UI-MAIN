<div class="new-project-grid">
  <!-- Left: Interactive Blueprint Viewer -->
  <div class="blueprint-viewer-card">
    <div class="card">
      <!-- Header strip inside viewer -->
      <div class="blueprint-viewer-header">
        <div>• INTERACTIVE BLUEPRINT VIEWER •</div>
        <div *ngIf="flow.step === 'extracting' || flow.step === 'finalizing'" class="progress-bar-container">
          <span>
            {{ flow.step === 'extracting' ? 'AI Metadata Extraction' : 'Finalizing Adjustments' }}
          </span>
          <div class="progress-bar">
            <div class="progress-bar-value" [style.width.%]="isExtracting(flow) || isFinalizing(flow) ? flow.pct : 0"></div>
          </div>
        </div>
      </div>

      <!-- Canvas area -->
      <div class="blueprint-viewer-canvas" appDragAndDrop (fileDropped)="onFileDropped($event)" #dropZone>
        <!-- PDF Viewer -->
        <ng2-pdfjs-viewer
          #pdfViewer
          *ngIf="pdfSrc"
          [pdfSrc]="pdfSrc"
          [viewerId]="viewerId"
          [showSpinner]="true"
          [theme]="'dark'"
        ></ng2-pdfjs-viewer>

        <!-- Mock blueprint grid -->
        <div class="blueprint-grid" *ngIf="!pdfSrc"></div>

        <!-- Highlight box -->
        <!-- <div *ngIf="flow.step === 'walkthrough' || flow.step === 'uploaded' || flow.step === 'extracting' || flow.step === 'address'"
             class="highlight-box"
             [style.left]="HIGHLIGHTS[currentKey].left"
             [style.top]="HIGHLIGHTS[currentKey].top"
             [style.width]="HIGHLIGHTS[currentKey].w"
             [style.height]="HIGHLIGHTS[currentKey].h"
             [style.border-color]="isWalkthrough(flow) ? SECTION_ORDER[flow.index].color : BRAND.yellow012">
        </div> -->

        <!-- Upload state overlay -->
        <div *ngIf="flow.step === 'idle'" class="upload-overlay" [class.file-over]="dropZone.classList.contains('file-over')">
          <h4>Upload Blueprint</h4>
          <p>Drag & drop a PDF here or click to select</p>
          <input type="file" accept=".pdf" (change)="onFileSelected($event)" style="display: none" #fileInput multiple>
          <button class="btn-primary" (click)="openUploadDialog()">
            Choose File
          </button>
        </div>

        <!-- File selection dropdown -->
        <div *ngIf="uploadedFiles.length > 0" class="file-list-container">
          <button class="file-list-toggle" (click)="isFileListCollapsed = !isFileListCollapsed">
            <i class="fas fa-chevron-down" [class.rotated]="isFileListCollapsed"></i>
            <span>{{ uploadedFiles.length }} Files Uploaded</span>
          </button>
          <div class="file-list" [class.collapsed]="isFileListCollapsed">
            <ul>
              <li *ngFor="let file of uploadedFiles" [class.selected]="file === selectedFile" (click)="onPdfSelectionChange(file)">
                <span>{{ file.name }}</span>
                <button (click)="removeFile(file)" class="remove-btn">
                  &times;
                </button>
              </li>
            </ul>
          </div>
        </div>

        <!-- Extracting overlay -->
        <div *ngIf="flow.step === 'extracting'" class="upload-overlay">
          <lucide-icon name="hard-hat" class="animate-spin"></lucide-icon>
          <div>Reading sheets, title blocks, site info…</div>
        </div>

        <!-- Address confirmation modal -->
        <div *ngIf="flow.step === 'address'" class="address-modal">
          <div class="address-modal-content">
            <div class="address-modal-header">
              <lucide-icon name="map-pin"></lucide-icon> Confirm Project Location
            </div>
            <div class="address-modal-body">
              <label>Detected address</label>
              <input [(ngModel)]="addressField">
              <div>Weather & region pricing will use this location.</div>
              <div class="address-modal-actions">
                <button class="btn-primary" (click)="setFlow('walkthrough', { index: 0, notes: {} })">
                  Confirm Address
                </button>
                <button class="btn-ghost" (click)="setFlow('extracting', { pct: 80 })">
                  Back
                </button>
              </div>
            </div>
            <div class="map-preview">
              <div>[ Map Preview Placeholder ]</div>
            </div>
          </div>
        </div>

        <!-- Right-side vertical tools -->
        <div class="toolbar">
          <button *ngFor="let button of rightToolbarButtons" [title]="button.label" class="toolbar-button"
                  (click)="handleToolbarClick(button.key)" [disabled]="flow.step === 'idle' || button.disabled">
            <lucide-icon [img]="button.icon"></lucide-icon>
          </button>

          <!-- Unit toggle -->
          <button title="Toggle Units" class="toolbar-button"
                  (click)="metric = !metric" [disabled]="true">
            {{ metric ? 'm / mm' : 'ft / in' }}
          </button>
        </div>
      </div>

      <!-- Viewer footer actions -->
      <div class="viewer-footer">
        <!-- Row 1: status + Start button -->
        <div class="footer-row">
          <div class="status-text">
            <span *ngIf="isUploaded(flow)">Ready: {{ flow.fileName }}</span>
            <span *ngIf="flow.step !== 'uploaded' && flow.step !== 'idle'">Mode: {{ analysisMode }}</span> | Zoom: {{ zoom * 100}}% | Units: {{ metric ? 'Metric' : 'Imperial' }}
          </div>
          <div class="footer-actions">
            <!-- <span *ngIf="flow.step === 'idle'">Select a file to begin</span> -->

            <span *ngIf="flow.step === 'walkthrough'">Active section: <b>{{ currentKey }}</b></span>
          </div>
        </div>

        <!-- Row 2: Analysis options + actions -->
        <div class="footer-row">
          <div class="analysis-options">
            <label>
              <input type="radio" name="analysis" [checked]="analysisMode === 'full'" (change)="analysisMode = 'full'">
              <span>Full Blueprint Analysis</span>
            </label>
            <label>
              <input type="radio" name="analysis" [checked]="analysisMode === 'selected'" (change)="analysisMode = 'selected'">
              <span>Selected Blueprint Analysis</span>
            </label>
            <label>
              <input type="radio" name="analysis" [checked]="analysisMode === 'renovation'" (change)="analysisMode = 'renovation'">
              <span>Renovation Analysis</span>
            </label>
          </div>

          <div class="footer-actions">
            <button *ngIf="flow.step === 'uploaded'" class="btn-primary" (click)="setFlow('extracting', { pct: 5 })">
              Start Project
            </button>
            <!-- <button class="btn-ghost" [disabled]="flow.step === 'idle'" (click)="analyze()">
              Analyze
            </button> -->
            <!-- <button class="btn-ghost" (click)="viewUploadedFiles()" [disabled]="flow.step === 'idle'">View Uploaded Files</button> -->
            <button class="btn-primary" (click)="cancel()" [disabled]="flow.step === 'idle'">Cancel</button>
            <!-- <button class="btn-primary" (click)="openUploadDialog()">
              Upload Blueprints
            </button> -->
          </div>
        </div>
        <!-- Row 3: Dropdown for selected analysis -->
        <div *ngIf="analysisMode === 'selected'" class="footer-row">
            <div class="analysis-options-details">
                <mat-form-field appearance="fill">
                    <mat-label>Select Prompts</mat-label>
                    <mat-select [formControl]="selectedPrompts" multiple>
                        <mat-option *ngFor="let prompt of availablePrompts$ | async" [value]="prompt.id">
                            {{ prompt.promptName }}
                        </mat-option>
                    </mat-select>
                </mat-form-field>
            </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Right: Guided Walkthrough Panel -->
  <div class="guided-setup-card">
    <div class="card">
      <div class="guided-setup-header">
        <h3 *ngIf="flowType === 'walkthrough'">New Project – Guided Walkthrough</h3>
        <h3 *ngIf="flowType === 'standard'">New Project – Standard Analysis</h3>
        <span>AI Extract</span>
      </div>
         <!-- Flow Type Selector -->
        <div class="flow-type-selector">
          <label>
            <input type="radio" name="flowType" value="standard" [(ngModel)]="flowType">
            <span>Standard Analysis</span>
          </label>
          <label>
            <input type="radio" name="flowType" value="walkthrough" [(ngModel)]="flowType">
            <span>Guided Walkthrough</span>
          </label>
        </div>
      <div class="progress-steps" *ngIf="flowType === 'walkthrough'">
        <span *ngFor="let step of progressSteps" class="progress-step" [class.done]="step.done">
          <lucide-icon *ngIf="step.done" name="check-circle"></lucide-icon>
          <span *ngIf="!step.done" class="progress-step-dot"></span>
          {{ step.k }}
        </span>
      </div>

      <!-- Standard Analysis Container -->
      <div *ngIf="flowType === 'standard'" class="standard-analysis-container">
        <h4>Standard Analysis Options</h4>

        <mat-accordion multi>
          <mat-expansion-panel [expanded]="true">
            <mat-expansion-panel-header>
              <mat-panel-title>Project Details</mat-panel-title>
            </mat-expansion-panel-header>
            <div [formGroup]="clientForm">
              <div class="form-row">
                <mat-form-field appearance="fill">
                  <mat-label>Project Name</mat-label>
                  <input matInput formControlName="projectName">
                </mat-form-field>
              </div>
              <mat-form-field appearance="fill">
                <mat-label>Start Date</mat-label>
                <input matInput [matDatepicker]="picker" formControlName="startDate" readonly (click)="picker.open()">
                <mat-datepicker-toggle matSuffix [for]="picker"></mat-datepicker-toggle>
                <mat-datepicker #picker></mat-datepicker>
              </mat-form-field>
            </div>
            <div class="form-row">
              <div [formGroup]="addressForm" class="address-container">
                <mat-form-field appearance="fill" class="address-form-field">
                  <mat-label>Address</mat-label>
                  <input matInput [formControl]="addressControl" [matAutocomplete]="auto" placeholder="Enter an address">
                  <mat-autocomplete #auto="matAutocomplete" (optionSelected)="onAddressSelected($event)">
                    <mat-option *ngFor="let option of options" [value]="option">
                      {{ option.description }}
                    </mat-option>
                  </mat-autocomplete>
                </mat-form-field>
              </div>
            </div>
            <mat-form-field appearance="fill">
              <mat-label>Budget Level</mat-label>
              <mat-select [(ngModel)]="budgetLevel">
                <mat-option value="high">High</mat-option>
                <mat-option value="medium">Medium</mat-option>
                <mat-option value="low">Low</mat-option>
              </mat-select>
            </mat-form-field>
          </mat-expansion-panel>
          <mat-expansion-panel>
            <mat-expansion-panel-header>
              <mat-panel-title>Client Details</mat-panel-title>
            </mat-expansion-panel-header>
            <div [formGroup]="clientForm">
              <div class="form-row">
                <mat-form-field appearance="fill">
                  <mat-label>First Name</mat-label>
                  <input matInput formControlName="firstName">
                </mat-form-field>
                <mat-form-field appearance="fill">
                  <mat-label>Last Name</mat-label>
                  <input matInput formControlName="lastName">
                </mat-form-field>
              </div>
              <div class="form-row">
                <mat-form-field appearance="fill">
                  <mat-label>Email</mat-label>
                  <input matInput formControlName="email">
                </mat-form-field>
                <mat-form-field appearance="fill">
                  <mat-label>Phone</mat-label>
                  <input matInput formControlName="phone">
                </mat-form-field>
                <mat-form-field appearance="fill">
                  <mat-label>Company Name</mat-label>
                  <input matInput formControlName="companyName">
                </mat-form-field>
                <mat-form-field appearance="fill">
                  <mat-label>Position</mat-label>
                  <input matInput formControlName="position">
                </mat-form-field>
              </div>
            </div>
          </mat-expansion-panel>
        </mat-accordion>

        <mat-form-field appearance="fill" *ngIf="analysisType === 'Selected'">
          <mat-label>Select Prompts</mat-label>
          <mat-select [formControl]="selectedPrompts" multiple>
            <mat-option *ngFor="let prompt of availablePrompts$ | async" [value]="prompt.id">
              {{ prompt.promptName }}
            </mat-option>
          </mat-select>
        </mat-form-field>

        <button class="btn-primary" (click)="startStandardAnalysis()" [disabled]="!selectedFile" matTooltip="Begin the analysis with the selected options">
          <lucide-icon name="hard-hat" class="animate-spin" *ngIf="isLoading"></lucide-icon>
          <span *ngIf="!isLoading">Start Analysis</span>
        </button>

        <!-- Real-time Progress Display -->
        <div *ngIf="isLoading && flowType === 'standard' && (state$ | async)?.analysisProgress as progress" class="analysis-progress-container">
            <h4>Analysis in Progress...</h4>
            <mat-progress-bar mode="determinate" [value]="(progress.currentStep / progress.totalSteps) * 100"></mat-progress-bar>
            <p *ngIf="progress.currentStep > 0">Step {{ progress.currentStep }} of {{ progress.totalSteps }}</p>
            <p>{{ progress.statusMessage }}</p>
            <p *ngIf="progress.currentStep === 0">Your job is being queued...</p>
            <div *ngIf="progress.hasFailed" class="error-message">
              <mat-card class="error-card">
                <mat-card-header>
                  <mat-card-title>Analysis Failed</mat-card-title>
                </mat-card-header>
                <mat-card-content>
                  <p>{{ progress.errorMessage }}</p>
                </mat-card-content>
                <mat-card-actions>
                  <button mat-button (click)="isLoading = false">Dismiss</button>
                </mat-card-actions>
              </mat-card>
            </div>
        </div>
      </div>

      <!-- Enhanced Walkthrough Container -->
      <div *ngIf="flowType === 'walkthrough'" class="walkthrough-container">
        <!-- Stepper/Progress Bar -->
        <div class="walkthrough-stepper">
          <ng-container *ngIf="state$ | async as state">
            <ul class="stepper-list">
              <li *ngFor="let step of state.walkthroughHistory; let i = index"
                  class="stepper-item"
                  [class.is-active]="i === state.currentWalkthroughStep"
                  [class.is-complete]="i < state.currentWalkthroughStep">
                <div class="stepper-indicator">
                  <div class="stepper-line"></div>
                  <div class="stepper-dot"></div>
                </div>
                <div class="stepper-label">
                  {{ step.promptKey | titlecase }}
                </div>
              </li>
            </ul>
          </ng-container>
        </div>

        <mat-form-field appearance="fill">
          <mat-label>Start Date</mat-label>
          <input matInput [matDatepicker]="picker" formControlName="startDate" readonly (click)="picker.open()">
          <mat-datepicker-toggle matSuffix [for]="picker"></mat-datepicker-toggle>
          <mat-datepicker #picker></mat-datepicker>
        </mat-form-field>

        <mat-form-field appearance="fill">
            <mat-label>Budget Level</mat-label>
            <mat-select [(ngModel)]="budgetLevel">
                <mat-option value="high">High</mat-option>
                <mat-option value="medium">Medium</mat-option>
                <mat-option value="low">Low</mat-option>
            </mat-select>
        </mat-form-field>

        <!-- AI Response Viewer -->
        <div class="response-viewer" (scroll)="onResponseViewerScroll($event)">
          <div *ngIf="state$ | async as state">
            <div *ngIf="state.flowType === 'walkthrough' && state.walkthroughHistory.length > 0">
              <app-rich-text-editor
                [initialContent]="state.walkthroughHistory[state.currentWalkthroughStep].aiResponse"
                (contentChanged)="onEditorContentChanged($event)">
              </app-rich-text-editor>
              <textarea [(ngModel)]="currentUserComments" placeholder="Add general comments here..."></textarea>
              <button class="btn-secondary" (click)="undo()">Undo</button>
              <button class="btn-secondary" (click)="redo()">Redo</button>
              <mat-checkbox [(ngModel)]="applyCostOptimisation">Apply Cost Optimisation and Efficiency</mat-checkbox>
              <button class="btn-primary" (click)="rerunCurrentStep()" matTooltip="Rerun the analysis for this step with your changes.">
                <lucide-icon name="hard-hat" class="animate-spin" *ngIf="isRerunningStep"></lucide-icon>
                <span *ngIf="!isRerunningStep">Rerun with my edits</span>
              </button>
            </div>
          </div>
        </div>

        <!-- Navigation Buttons -->
        <div class="walkthrough-navigation">
          <button class="btn-ghost" (click)="goToPreviousStep()" matTooltip="Go back to the previous step.">Back</button>
          <button class="btn-primary" (click)="goToNextStep()" [disabled]="!hasScrolledToBottom" matTooltip="Proceed to the next step in the walkthrough.">
            <lucide-icon name="hard-hat" class="animate-spin" *ngIf="isNavigatingNext"></lucide-icon>
            <span *ngIf="!isNavigatingNext">Next</span>
          </button>
        </div>
      </div>

      <div [ngSwitch]="flow.step" class="step-switcher" *ngIf="flowType === 'walkthrough'">
        <p *ngSwitchCase="'idle'">Start by uploading a blueprint and selecting your project start date</p>

        <div *ngSwitchCase="'uploaded'" class="info-block">
          <h4>Ready to start?</h4>
          <p>We’ll parse sheets, title blocks, scales, and more.</p>
          <div class="info-block-actions">
            <button class="btn-primary" (click)="setFlow('extracting', { pct: 5 })">
              Begin Extraction
            </button>
            <button class="btn-primary" (click)="cancel()" [disabled]="flow.step === 'idle'">Replace File</button>
          </div>
        </div>

        <div *ngSwitchCase="'extracting'" class="info-block">
          <div class="info-block-header">
            <lucide-icon name="hard-hat" class="animate-spin"></lucide-icon>
            <h4>AI Metadata Extraction</h4>
          </div>
          <p>Pulling address, sheets, and site details…</p>
        </div>

        <div *ngSwitchCase="'address'" class="info-block">
          <h4>Confirm Address</h4>
          <p>We’ll sync weather + regional pricing once confirmed.</p>
          <div>Detected: <b>{{ addressField }}</b></div>
          <div class="info-block-actions">
            <button class="btn-primary" (click)="setFlow('walkthrough', { index: 0, notes: {} })">
              Confirm & Continue
            </button>
            <button class="btn-ghost" (click)="setFlow('extracting', { pct: 85 })">
              Edit Again
            </button>
          </div>
        </div>

        <div *ngSwitchCase="'walkthrough'" class="walkthrough-panel">
          <div class="walkthrough-header">
            <div>
              <div *ngIf="isWalkthrough(flow)">Section {{ flow.index + 1 }} of {{ SECTION_ORDER.length }}</div>
              <h4 *ngIf="isWalkthrough(flow)" [style.color]="SECTION_ORDER[flow.index].color">{{ SECTION_ORDER[flow.index].key }}</h4>
            </div>
            <div class="walkthrough-progress">
              <span *ngFor="let section of SECTION_ORDER; let i = index" class="walkthrough-progress-dot"
                    [class.active]="isWalkthrough(flow) && i <= flow.index"
                    [style.background]="section.color"></span>
            </div>
          </div>
          <div *ngIf="isWalkthrough(flow)">{{ defaultDesc[SECTION_ORDER[flow.index].key] }}</div>
          <div *ngIf="isWalkthrough(flow)" class="notes-section">
            <label>Add notes or changes (optional)</label>
            <textarea [(ngModel)]="flow.notes[SECTION_ORDER[flow.index].key]"
                      [placeholder]="getPlaceholder(SECTION_ORDER[flow.index].key)">
            </textarea>
          </div>
          <div class="walkthrough-actions">
            <div>Your input updates the BoM at the end.</div>
            <button class="btn-primary" (click)="nextStep()">
              <span *ngIf="isWalkthrough(flow)">{{ flow.index === SECTION_ORDER.length - 1 ? 'Finish' : 'Next' }}</span>
            </button>
          </div>
        </div>

        <div *ngSwitchCase="'finalizing'" class="info-block">
          <div class="info-block-header">
            <lucide-icon name="hard-hat" class="animate-spin"></lucide-icon>
            <h4>Finalizing</h4>
          </div>
          <p>Applying your adjustments to the BoM & scope.</p>
          <p>Reanalyzing blueprint and updating quantities…</p>
        </div>

        <div *ngSwitchCase="'done'" class="info-block">
          <div class="info-block-header">
            <lucide-icon name="check-circle"></lucide-icon>
            <h4>AI Analysis Complete</h4>
          </div>
          <p>Your edits have been applied. Download your outputs below.</p>
          <div class="info-block-actions">
            <button class="btn-primary">View Final Bill of Materials</button>
            <button class="btn-primary">Download Project Summary</button>
            <button class="btn-ghost">Launch Bidding Phase</button>
          </div>
          <div class="info-block-actions">
            <button class="btn-ghost" (click)="setFlow('idle')">Start Another</button>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>
