<div class="dashboard-container">
  <!-- Job Details Card -->
  <mat-card class="job-details-card">
    <mat-card-content>
      <div *ngIf="isLoading">
        <app-loader></app-loader>
      </div>
      <div class="job-details">
        <p><strong>Start Date:</strong> {{ startDateDisplay }}</p>
        <div class="address-container">
          <div *ngIf="!isEditingAddress" class="address-display">
            <span
              ><strong>Address: </strong>
              <span *ngIf="projectDetails?.address">{{
                projectDetails?.address
              }}</span>
              <span
                *ngIf="
                  !projectDetails?.address &&
                  projectDetails?.jobAddress?.formatted_address
                "
                >{{ projectDetails.jobAddress.formatted_address }}</span
              >
            </span>
            <button
              *ngIf="authService.hasPermission('editJobs')"
              mat-icon-button
              (click)="toggleAddressEdit(true)"
              class="edit-icon"
            >
              <mat-icon>edit</mat-icon>
            </button>
          </div>
          <div *ngIf="isEditingAddress" class="address-edit">
            <mat-form-field appearance="fill">
              <mat-label>Address</mat-label>
              <input
                #addressInput
                matInput
                [formControl]="addressControl"
                [matAutocomplete]="auto"
                placeholder="Enter an address"
              />
              <mat-autocomplete
                #auto="matAutocomplete"
                (optionSelected)="onAddressSelected($event)"
              >
                <mat-option
                  *ngFor="let suggestion of addressSuggestions"
                  [value]="suggestion"
                >
                  {{ suggestion.description }}
                </mat-option>
              </mat-autocomplete>
            </mat-form-field>
            <div class="edit-buttons">
              <button
                mat-raised-button
                color="primary"
                (click)="saveAddress()"
                [disabled]="isLoading"
              >
                Save
              </button>
              <button mat-button (click)="toggleAddressEdit(false)">
                Cancel
              </button>
            </div>
          </div>
        </div>
        <div *ngIf="forecast?.length" class="weather-scroll-container">
          <div *ngFor="let day of forecast" class="forecast-card">
            <div class="date">{{ day.date }}</div>
            <img [src]="day.iconUrl" alt="Weather Icon" />
            <div class="condition">{{ day.condition }}</div>
            <div class="temp">
              <span class="high"
                >{{
                  measurementService.convertTemperature(day.highTemp)
                    | number: "1.0-0"
                }}°{{ temperatureUnit }}</span
              >
              <span class="low"
                >{{
                  measurementService.convertTemperature(day.lowTemp)
                    | number: "1.0-0"
                }}°{{ temperatureUnit }}</span
              >
            </div>
            <div class="precip">{{ day.precipitationProbability }}%</div>
          </div>
        </div>

        <div *ngIf="weatherError" class="weather-error">
          {{ weatherError }}
        </div>
      </div>
    </mat-card-content>
  </mat-card>

  <div class="overview-header">
    <div class="header-text">
      <h3 class="title">Project Overview Dashboard</h3>
    </div>
    <div class="status-indicator">
      <div
        class="dot pulse"
        [class.red]="behindScheduleCount > 0"
        [class.green]="behindScheduleCount === 0"
      ></div>
      <span class="label">
        {{
          behindScheduleCount > 0
            ? behindScheduleCount + " Tasks Behind Schedule"
            : "All Tasks On Track"
        }}
      </span>
    </div>
  </div>

  <div class="cards-grid">
    <!-- LEFT COLUMN -->
    <div class="grid-column">
      <div class="overview-card">
        <h4 class="card-header">
          <lucide-angular
            [img]="Building2"
            class="header-icon"
          ></lucide-angular>
          Active Project Summary
        </h4>
        <div class="card-content">
          <div class="stats-grid">
            <div class="stat-item">
              <p class="stat-label">Total Projects</p>
              <p class="stat-value">HARDCODED 1</p>
            </div>
            <div class="stat-item">
              <p class="stat-label">Active Value</p>
              <p class="stat-value">
                {{ activeValue | currency: "USD" : "symbol" : "1.0-0" }}
              </p>
            </div>
          </div>
          <div class="info-list">
            <div class="info-row">
              <div class="info-label-group">
                <lucide-angular
                  [img]="User"
                  class="icon-muted"
                ></lucide-angular>
                <span class="label">GC Account Owner</span>
              </div>
              <span class="value">{{ ownerName }}</span>
            </div>
            <div class="info-row">
              <div class="info-label-group">
                <lucide-angular
                  [img]="Users"
                  class="icon-muted"
                ></lucide-angular>
                <span class="label">Assigned Team</span>
              </div>
              <span class="value">{{ teamMemberCount }} Members</span>
            </div>
            <div class="info-row">
              <div class="info-label-group">
                <lucide-angular
                  [img]="MapPin"
                  class="icon-muted"
                ></lucide-angular>
                <span class="label">Active Sites</span>
              </div>
              <span class="value">HARDCODED Locations</span>
            </div>
          </div>
        </div>
      </div>

      <div class="overview-card">
        <h4 class="card-header">
          <lucide-angular
            [img]="FileStack"
            class="header-icon"
          ></lucide-angular>
          Blueprint Intelligence
        </h4>
        <div class="info-list">
          <div class="info-row">
            <div class="info-label-group">
              <lucide-angular [img]="Hash" class="icon-muted"></lucide-angular>
              <span class="label">Total Sheets Uploaded</span>
            </div>
            <span class="value">HARDCODED sheets</span>
          </div>
          <div class="info-row">
            <div class="info-label-group">
              <lucide-angular [img]="Home" class="icon-muted"></lucide-angular>
              <span class="label">Rooms Detected</span>
            </div>
            <div class="info-action-group">
              <span class="value">HARDCODED rooms</span>
              <button class="btn-text">View List</button>
            </div>
          </div>
          <div class="info-row">
            <div class="info-label-group">
              <lucide-angular [img]="Ruler" class="icon-muted"></lucide-angular>
              <span class="label">Elements Detected</span>
            </div>
            <span class="value">HARDCODED elements</span>
          </div>
          <div class="info-row success-row">
            <div class="info-label-group">
              <lucide-angular
                [img]="CheckCircle2"
                class="icon-success"
              ></lucide-angular>
              <span class="label">Measurement Accuracy</span>
            </div>
            <span class="value text-success">HARDCODED%</span>
          </div>
        </div>
      </div>

      <div class="overview-card">
        <h4 class="card-header">
          <lucide-angular [img]="Clock" class="header-icon"></lucide-angular>
          Timeline Overview
        </h4>
        <div class="card-content">
          <div class="stats-grid">
            <div class="stat-item">
              <p class="stat-label">Total Duration</p>
              <p class="stat-value">{{ totalDuration }} weeks</p>
            </div>
            <div class="stat-item">
              <p class="stat-label">Current Week</p>
              <p class="stat-value">Week {{ currentWeek }}</p>
            </div>
          </div>
          <div class="outlook-panel">
            <p class="outlook-title">Next 7-Day Outlook</p>
            <div class="outlook-list">
              <div *ngFor="let task of outlookTasks" class="outlook-item">
                <div class="dot blue"></div>
                <span>{{ task.name }}</span>
              </div>
              <div *ngIf="outlookTasks.length === 0" class="outlook-item">
                <span>No tasks scheduled for next 7 days</span>
              </div>
            </div>
          </div>
        </div>
      </div>

      <div class="overview-card">
        <h4 class="card-header">
          <lucide-angular [img]="Activity" class="header-icon"></lucide-angular>
          Live Site Activity
        </h4>
        <div class="info-list">
          <div class="info-row">
            <div class="info-label-group">
              <lucide-angular [img]="Camera" class="icon-blue"></lucide-angular>
              <span class="label">Photos Uploaded Today</span>
            </div>
            <span class="value">HARDCODED photos</span>
          </div>
          <div class="info-row">
            <div class="info-label-group">
              <lucide-angular
                [img]="CheckCircle2"
                class="icon-success"
              ></lucide-angular>
              <span class="label">Tasks Completed Today</span>
            </div>
            <span class="value">HARDCODED tasks</span>
          </div>
          <div class="info-row warning-row">
            <div class="info-label-group">
              <lucide-angular
                [img]="AlertCircle"
                class="icon-warning"
              ></lucide-angular>
              <span class="label">Tasks Behind Schedule</span>
            </div>
            <span class="value text-warning"
              >{{ behindScheduleCount }} tasks</span
            >
          </div>
        </div>
      </div>

      <div class="overview-card">
        <h4 class="card-header">
          <lucide-angular
            [img]="ShieldAlert"
            class="header-icon"
          ></lucide-angular>
          Compliance & Risk Indicators
        </h4>
        <div class="info-list">
          <div class="info-row success-row">
            <div class="info-label-group">
              <lucide-angular
                [img]="CheckCircle2"
                class="icon-success"
              ></lucide-angular>
              <span class="label">Building Codes</span>
            </div>
            <span class="value text-success">HARDCODED</span>
          </div>
          <div class="info-row success-row">
            <div class="info-label-group">
              <lucide-angular
                [img]="CheckCircle2"
                class="icon-success"
              ></lucide-angular>
              <span class="label">Permits Status</span>
            </div>
            <span class="value text-success">HARDCODED</span>
          </div>
          <div class="info-row warning-row">
            <div class="info-label-group">
              <lucide-angular
                [img]="CloudRain"
                class="icon-warning"
              ></lucide-angular>
              <span class="label">Weather Risk</span>
            </div>
            <span class="value text-warning">HARDCODED</span>
          </div>
          <div class="info-row">
            <div class="info-label-group">
              <lucide-angular
                [img]="FileWarning"
                class="icon-muted"
              ></lucide-angular>
              <span class="label">Conflict Detection</span>
            </div>
            <span class="value">HARDCODED items flagged</span>
          </div>
        </div>
      </div>
    </div>

    <!-- RIGHT COLUMN -->
    <div class="grid-column">
      <div class="overview-card">
        <h4 class="card-header">
          <lucide-angular [img]="PieChart" class="header-icon"></lucide-angular>
          BOM + Cost Snapshot
        </h4>
        <div class="card-content">
          <div class="highlight-panel">
            <p class="stat-label">Total Project Cost</p>
            <p class="stat-value-large">
              {{ activeValue | currency: "USD" : "symbol" : "1.0-0" }}
            </p>
          </div>
          <div class="cost-breakdown">
            <p class="section-subtitle">Cost by Division</p>
            <div *ngFor="let phase of costByPhase" class="cost-item">
              <span>{{ phase.name }}</span>
              <span class="cost-value">{{
                phase.value | currency: "USD" : "symbol" : "1.0-0"
              }}</span>
            </div>
            <div *ngIf="costByPhase.length === 0" class="cost-item">
              <span>No cost data available</span>
            </div>
          </div>
          <div class="cost-footer">
            <span class="label">Material vs Labour</span>
            <span class="value"
              >{{ materialPercent }}% / {{ laborPercent }}%</span
            >
          </div>
          <button class="btn-action" (click)="onOpenBudget()">
            Open Full Estimate →
          </button>
        </div>
      </div>

      <div class="overview-card">
        <h4 class="card-header">
          <lucide-angular [img]="Hammer" class="header-icon"></lucide-angular>
          Bidding Status Summary
        </h4>
        <div class="card-content">
          <div class="stats-grid">
            <div class="stat-box">
              <p class="stat-label">Trades Required</p>
              <p class="stat-value">HARDCODED</p>
            </div>
            <div class="stat-box">
              <p class="stat-label">Bids Received</p>
              <p class="stat-value text-success">{{ bidsReceived }}</p>
            </div>
          </div>
          <div class="info-list">
            <div class="info-row">
              <span class="label">Invited (Platform)</span>
              <span class="value">HARDCODED trades</span>
            </div>
            <div class="info-row">
              <span class="label">Invited (External)</span>
              <span class="value">HARDCODED trades</span>
            </div>
            <div class="info-row warning-row">
              <span class="label">Pending Response</span>
              <span class="value text-warning">HARDCODED trades</span>
            </div>
          </div>
          <div class="card-footer">
            <p class="stat-label">Bidding Round</p>
            <p class="value">HARDCODED Round</p>
          </div>
        </div>
      </div>

      <div class="overview-card">
        <h4 class="card-header">
          <lucide-angular [img]="Users" class="header-icon"></lucide-angular>
          Subcontractor Overview
        </h4>
        <div class="card-content">
          <div class="stats-grid">
            <div class="stat-box">
              <p class="stat-label">Confirmed Subs</p>
              <p class="stat-value">HARDCODED</p>
            </div>
            <div class="stat-box">
              <p class="stat-label">Pending Subs</p>
              <p class="stat-value text-warning">HARDCODED</p>
            </div>
          </div>
          <div class="sub-list">
            <div class="sub-item">
              <span>Concrete & Foundation</span>
              <lucide-angular
                [img]="CheckCircle2"
                class="icon-success"
              ></lucide-angular>
            </div>
            <div class="sub-item">
              <span>Electrical</span>
              <lucide-angular
                [img]="CheckCircle2"
                class="icon-success"
              ></lucide-angular>
            </div>
            <div class="sub-item">
              <span>Plumbing</span>
              <lucide-angular
                [img]="CheckCircle2"
                class="icon-success"
              ></lucide-angular>
            </div>
            <div class="sub-item">
              <span>HVAC</span>
              <lucide-angular
                [img]="Clock"
                class="icon-warning"
              ></lucide-angular>
            </div>
          </div>
        </div>
      </div>

      <div class="overview-card">
        <h4 class="card-header">
          <lucide-angular [img]="Folder" class="header-icon"></lucide-angular>
          Document Hub
        </h4>
        <div class="button-list">
          <button class="btn-action-row">
            <lucide-angular [img]="FileStack" class="btn-icon"></lucide-angular>
            Contracts (HARDCODED)
          </button>
          <button class="btn-action-row">
            <lucide-angular
              [img]="FileWarning"
              class="btn-icon"
            ></lucide-angular>
            RFIs (HARDCODED)
          </button>
          <button class="btn-action-row">
            <lucide-angular
              [img]="CheckCircle2"
              class="btn-icon"
            ></lucide-angular>
            Inspections (HARDCODED)
          </button>
          <button class="btn-action-row">
            <lucide-angular [img]="Camera" class="btn-icon"></lucide-angular>
            Progress Photos (HARDCODED)
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- Recent Projects -->
  <div class="recent-projects">
    <div class="carousel-header">
      <h4 class="section-title">Recent Projects</h4>
      <div class="view-toggle">
        <button
          mat-icon-button
          (click)="toggleProjectView('grid')"
          [class.active]="projectView === 'grid'"
          matTooltip="Grid View"
          [matTooltipShowDelay]="500"
        >
          <mat-icon>grid_view</mat-icon>
        </button>
        <button
          mat-icon-button
          (click)="toggleProjectView('list')"
          [class.active]="projectView === 'list'"
          matTooltip="List View"
          [matTooltipShowDelay]="500"
        >
          <mat-icon>list</mat-icon>
        </button>
      </div>
      <div class="carousel-controls" *ngIf="projectView === 'grid'">
        <button
          mat-icon-button
          (click)="prevProject()"
          [disabled]="currentIndex === 0"
        >
          <mat-icon>chevron_left</mat-icon>
        </button>
        <button
          mat-icon-button
          (click)="nextProject()"
          [disabled]="currentIndex >= projects.length - 3"
        >
          <mat-icon>chevron_right</mat-icon>
        </button>
      </div>
    </div>
    <div *ngIf="projectView === 'grid'" class="projects-carousel">
      <app-project-card
        *ngFor="let project of visibleProjects"
        [project]="project"
        (onView)="loadJob($event)"
        (onArchive)="archiveJob($event)"
      ></app-project-card>
    </div>
    <div *ngIf="projectView === 'list'">
      <app-projects-table
        [projects]="projects"
        (onView)="loadJob($event)"
        (onArchive)="archiveJob($event)"
      >
      </app-projects-table>
    </div>
  </div>
</div>
