<!-- Financial Overview Panel -->
<div class="dashboard-grid">
  <div class="dashboard-card">
    <div class="card-header-row">
      <span>Total Budget</span>
      <mat-icon class="text-yellow">attach_money</mat-icon>
    </div>
    <p class="metric-value">${{ totalEstimated / 1000 | number: "1.0-0" }}K</p>
    <p class="metric-subtext">Original estimate</p>
  </div>

  <div class="dashboard-card">
    <div class="card-header-row">
      <span>Actual Spent</span>
      <mat-icon class="text-blue">trending_up</mat-icon>
    </div>
    <p class="metric-value">${{ totalActual / 1000 | number: "1.0-0" }}K</p>
    <p class="metric-subtext">
      {{ (totalActual / totalEstimated) * 100 | number: "1.1-1" }}% of budget
    </p>
  </div>

  <div class="dashboard-card">
    <div class="card-header-row">
      <span>Forecast at Completion</span>
      <mat-icon class="text-purple">trending_down</mat-icon>
    </div>
    <p class="metric-value">${{ totalForecast / 1000 | number: "1.0-0" }}K</p>
    <p class="metric-subtext">Projected final cost</p>
  </div>

  <div class="dashboard-card">
    <div class="card-header-row">
      <span>Variance</span>
      <mat-icon [ngClass]="variance >= 0 ? 'text-green' : 'text-red'">
        {{ variance >= 0 ? "check_circle" : "error" }}
      </mat-icon>
    </div>
    <p
      class="metric-value"
      [ngClass]="variance >= 0 ? 'text-green' : 'text-red'"
    >
      {{ variance >= 0 ? "+" : "" }}${{ variance / 1000 | number: "1.0-0" }}K
    </p>
    <p class="metric-subtext">
      {{ variance >= 0 ? "Under" : "Over" }} budget by {{ variancePercent }}%
    </p>
  </div>
</div>

<!-- Performance Metrics -->
<div class="metrics-grid">
  <div class="dashboard-card p-6">
    <div class="metric-card-content">
      <div class="icon-box bg-primary-soft">
        <mat-icon class="text-primary">trending_up</mat-icon>
      </div>
      <div class="metric-details">
        <p class="label">Cost Performance Index</p>
        <p class="value">{{ cpi }}</p>
        <p class="subtext">
          {{ cpi >= "1" ? "Efficient spending" : "Over budget trend" }}
        </p>
      </div>
    </div>
  </div>

  <div class="dashboard-card p-6">
    <div class="metric-card-content">
      <div class="icon-box bg-blue-soft">
        <mat-icon class="text-blue">schedule</mat-icon>
      </div>
      <div class="metric-details">
        <p class="label">Pending Invoices</p>
        <p class="value">HARDCODED $45K</p>
        <p class="subtext">3 invoices awaiting payment</p>
      </div>
    </div>
  </div>

  <div class="dashboard-card p-6">
    <div class="metric-card-content">
      <div class="icon-box bg-purple-soft">
        <mat-icon class="text-purple">inventory_2</mat-icon>
      </div>
      <div class="metric-details">
        <p class="label">Procurement Commitments</p>
        <p class="value">
          ${{ procurementCommitments / 1000 | number: "1.0-0" }}K
        </p>
        <p class="subtext">Materials ordered</p>
      </div>
    </div>
  </div>
</div>

<!-- Budget Tracking Table -->
<mat-card class="mb-6">
  <div class="table-header-row">
    <h3>
      <ng-container [ngSwitch]="budgetTableTab">
        <span *ngSwitchCase="'all'">Budget Breakdown</span>
        <span *ngSwitchCase="'Subcontractor'"
          >Subcontractor & Labor Breakdown</span
        >
        <span *ngSwitchCase="'Materials'">Materials Breakdown</span>
        <span *ngSwitchCase="'Equipment'">Equipment Costs</span>
        <span *ngSwitchCase="'Other'">Other Costs</span>
      </ng-container>
    </h3>
    <div class="button-group">
      <button
        class="btn-outline-custom"
        (click)="importAiEstimates()"
        *ngIf="!isAddingLineItem"
        matTooltip="Import estimates from AI Analysis"
      >
        <mat-icon>smart_toy</mat-icon>
        Import AI
      </button>
      <button
        class="btn-outline-custom"
        (click)="startAddLineItem()"
        *ngIf="!isAddingLineItem"
      >
        <mat-icon>add</mat-icon>
        Add Line Item
      </button>
    </div>
  </div>

  <!-- Budget Table Tabs -->
  <div class="nav-tabs sub-tabs">
    <button
      (click)="setBudgetTableTab('all')"
      [class.active]="budgetTableTab === 'all'"
    >
      All
    </button>
    <button
      (click)="setBudgetTableTab('Subcontractor')"
      [class.active]="budgetTableTab === 'Subcontractor'"
    >
      Subcontractors & Labor
    </button>
    <button
      (click)="setBudgetTableTab('Materials')"
      [class.active]="budgetTableTab === 'Materials'"
    >
      Materials
    </button>
    <button
      (click)="setBudgetTableTab('Equipment')"
      [class.active]="budgetTableTab === 'Equipment'"
    >
      Equipment
    </button>
    <button
      (click)="setBudgetTableTab('Other')"
      [class.active]="budgetTableTab === 'Other'"
    >
      Other
    </button>
  </div>

  <div class="budget-table-container">
    <table class="budget-table">
      <thead>
        <tr>
          <th>Status</th>
          <th>Item</th>
          <th
            *ngIf="
              budgetTableTab === 'Subcontractor' ||
              budgetTableTab === 'all' ||
              budgetTableTab === 'Materials' ||
              budgetTableTab === 'Equipment'
            "
          >
            Vendor
          </th>
          <th
            *ngIf="
              budgetTableTab !== 'Materials' && budgetTableTab !== 'Equipment'
            "
          >
            Trade
          </th>
          <th
            *ngIf="
              budgetTableTab === 'Materials' ||
              budgetTableTab === 'Equipment' ||
              budgetTableTab === 'Subcontractor'
            "
          >
            {{ budgetTableTab === "Subcontractor" ? "Hours" : "Qty" }}
          </th>
          <th
            *ngIf="
              budgetTableTab === 'Materials' || budgetTableTab === 'Equipment'
            "
          >
            Unit
          </th>
          <th
            *ngIf="
              budgetTableTab === 'Materials' ||
              budgetTableTab === 'Equipment' ||
              budgetTableTab === 'Subcontractor'
            "
          >
            {{ budgetTableTab === "Subcontractor" ? "Rate" : "Unit Cost" }}
          </th>
          <th class="text-right">Estimated</th>
          <th class="text-right">Actual</th>
          <th class="text-right">Variance</th>
          <th class="text-right">% Complete</th>
          <th class="text-right">Forecast</th>
          <th>Notes</th>
          <th>Actions</th>
        </tr>
      </thead>
      <tbody>
        <!-- Add New Item Row -->
        <tr *ngIf="isAddingLineItem" class="edit-row bg-primary-soft">
          <td><mat-icon>add_circle_outline</mat-icon></td>
          <td>
            <input
              class="table-input"
              [(ngModel)]="newBudgetItem.item"
              placeholder="Item Name"
            />
          </td>

          <td
            *ngIf="
              budgetTableTab === 'Subcontractor' ||
              budgetTableTab === 'all' ||
              budgetTableTab === 'Materials' ||
              budgetTableTab === 'Equipment'
            "
          >
            <input
              class="table-input"
              [(ngModel)]="newBudgetItem.vendor"
              placeholder="Vendor"
            />
          </td>
          <td
            *ngIf="
              budgetTableTab !== 'Materials' && budgetTableTab !== 'Equipment'
            "
          >
            <input
              class="table-input"
              [(ngModel)]="newBudgetItem.trade"
              placeholder="Trade"
            />
          </td>

          <ng-container
            *ngIf="
              budgetTableTab === 'Materials' || budgetTableTab === 'Equipment'
            "
          >
            <td>
              <input
                type="number"
                class="table-input text-right"
                [(ngModel)]="newBudgetItem.quantity"
                (ngModelChange)="recalculateEstimatedCost(newBudgetItem)"
                placeholder="0"
              />
            </td>
            <td>
              <input
                class="table-input"
                [(ngModel)]="newBudgetItem.unit"
                placeholder="Unit"
              />
            </td>
            <td>
              <input
                type="number"
                class="table-input text-right"
                [(ngModel)]="newBudgetItem.unitCost"
                (ngModelChange)="recalculateEstimatedCost(newBudgetItem)"
                placeholder="0.00"
              />
            </td>
          </ng-container>

          <ng-container *ngIf="budgetTableTab === 'Subcontractor'">
            <td>
              <input
                type="number"
                class="table-input text-right"
                [(ngModel)]="newBudgetItem.quantity"
                (ngModelChange)="recalculateEstimatedCost(newBudgetItem)"
                placeholder="0"
              />
            </td>
            <td>
              <input
                type="number"
                class="table-input text-right"
                [(ngModel)]="newBudgetItem.unitCost"
                (ngModelChange)="recalculateEstimatedCost(newBudgetItem)"
                placeholder="0.00"
              />
            </td>
          </ng-container>

          <td>
            <input
              type="number"
              class="table-input text-right"
              [(ngModel)]="newBudgetItem.estimatedCost"
              placeholder="0"
            />
          </td>
          <td>
            <input
              type="number"
              class="table-input text-right"
              [(ngModel)]="newBudgetItem.actualCost"
              placeholder="0"
            />
          </td>
          <td class="text-center">-</td>
          <td class="text-right text-muted">0%</td>
          <td class="text-right text-muted">-</td>
          <td>
            <input
              class="table-input"
              [(ngModel)]="newBudgetItem.notes"
              placeholder="Notes"
            />
          </td>
          <td>
            <div class="action-buttons-row">
              <button
                mat-icon-button
                class="text-green"
                (click)="saveNewLineItem()"
                matTooltip="Save"
              >
                <mat-icon>check</mat-icon>
              </button>
              <button
                mat-icon-button
                class="text-red"
                (click)="cancelAddLineItem()"
                matTooltip="Cancel"
              >
                <mat-icon>close</mat-icon>
              </button>
            </div>
          </td>
        </tr>

        <tr *ngFor="let ticket of filteredBudgetItems">
          <ng-container *ngIf="editingItemId !== ticket.id; else editMode">
            <td>
              <!-- Check Circle (Green) -->
              <svg
                *ngIf="
                  getStatusIcon(
                    ticket.estimatedCost,
                    ticket.forecastToComplete
                  ) === 'check_circle'
                "
                xmlns="http://www.w3.org/2000/svg"
                width="20"
                height="20"
                viewBox="0 0 24 24"
                fill="none"
                stroke="currentColor"
                stroke-width="2"
                stroke-linecap="round"
                stroke-linejoin="round"
                class="text-green"
              >
                <path
                  d="M12 22c5.523 0 10-4.477 10-10S17.523 2 12 2 2 6.477 2 12s4.477 10 10 10z"
                />
                <path d="m9 12 2 2 4-4" />
              </svg>
              <!-- Alert Circle (Yellow/Red) -->
              <svg
                *ngIf="
                  getStatusIcon(
                    ticket.estimatedCost,
                    ticket.forecastToComplete
                  ) !== 'check_circle'
                "
                xmlns="http://www.w3.org/2000/svg"
                width="20"
                height="20"
                viewBox="0 0 24 24"
                fill="none"
                stroke="currentColor"
                stroke-width="2"
                stroke-linecap="round"
                stroke-linejoin="round"
                [ngClass]="
                  getStatusColor(
                    ticket.estimatedCost,
                    ticket.forecastToComplete
                  )
                "
              >
                <circle cx="12" cy="12" r="10" />
                <line x1="12" x2="12" y1="8" y2="12" />
                <line x1="12" x2="12.01" y1="16" y2="16" />
              </svg>
            </td>
            <td
              class="font-medium"
              [matTooltip]="ticket.phase ? 'Phase: ' + ticket.phase : ''"
            >
              {{ ticket.item }}
            </td>

            <td
              *ngIf="
                budgetTableTab === 'Subcontractor' ||
                budgetTableTab === 'all' ||
                budgetTableTab === 'Materials' ||
                budgetTableTab === 'Equipment'
              "
              class="text-muted"
            >
              {{ ticket.vendor || "-" }}
            </td>
            <td
              *ngIf="
                budgetTableTab !== 'Materials' && budgetTableTab !== 'Equipment'
              "
              class="text-muted"
            >
              {{ ticket.trade }}
            </td>

            <ng-container
              *ngIf="
                budgetTableTab === 'Materials' || budgetTableTab === 'Equipment'
              "
            >
              <td class="text-right">{{ ticket.quantity }}</td>
              <td class="text-muted">{{ ticket.unit }}</td>
              <td class="text-right">${{ ticket.unitCost }}</td>
            </ng-container>

            <ng-container *ngIf="budgetTableTab === 'Subcontractor'">
              <td class="text-right">{{ ticket.quantity }}</td>
              <td class="text-right">${{ ticket.unitCost }}</td>
            </ng-container>

            <td class="text-right font-medium">
              ${{ ticket.estimatedCost | number: "1.0-0" }}
            </td>
            <td class="text-right">
              ${{ ticket.actualCost | number: "1.0-0" }}
            </td>
            <td
              class="text-right font-medium"
              [ngClass]="
                getStatusColor(ticket.estimatedCost, ticket.forecastToComplete)
              "
            >
              {{ getVariance(ticket) >= 0 ? "+" : "" }}${{
                getVariance(ticket) | number: "1.0-0"
              }}
              <span style="font-size: 0.75rem; margin-left: 4px"
                >({{ getVariancePercent(ticket) }}%)</span
              >
            </td>
            <td class="text-right">
              <div class="progress-bar-wrapper">
                <div class="progress-track">
                  <div
                    class="progress-fill"
                    [style.width.%]="ticket.percentComplete"
                  ></div>
                </div>
                <span class="font-medium">{{ ticket.percentComplete }}%</span>
              </div>
            </td>
            <td class="text-right font-medium">
              <!-- Non-editable view (when not editing row) -->
              ${{ ticket?.forecastToComplete ?? 0 | number: "1.0-0" }}
            </td>
            <td
              class="text-muted"
              style="
                max-width: 200px;
                white-space: nowrap;
                overflow: hidden;
                text-overflow: ellipsis;
              "
              [matTooltip]="ticket.notes"
            >
              {{ ticket.notes }}
            </td>
            <td>
              <div class="action-buttons-row">
                <button
                  mat-icon-button
                  (click)="startEditLineItem(ticket)"
                  matTooltip="Edit"
                >
                  <mat-icon>edit</mat-icon>
                </button>
                <button
                  mat-icon-button
                  color="warn"
                  (click)="deleteLineItem(ticket)"
                  matTooltip="Delete"
                >
                  <mat-icon>delete</mat-icon>
                </button>
              </div>
            </td>
          </ng-container>

          <!-- Edit Mode Template -->
          <ng-template #editMode>
            <td><mat-icon>edit</mat-icon></td>
            <td>
              <input
                class="table-input"
                [(ngModel)]="editingItem!.item"
                placeholder="Item Name"
              />
            </td>

            <td
              *ngIf="
                budgetTableTab === 'Subcontractor' ||
                budgetTableTab === 'all' ||
                budgetTableTab === 'Materials' ||
                budgetTableTab === 'Equipment'
              "
            >
              <input
                class="table-input"
                [(ngModel)]="editingItem!.vendor"
                placeholder="Vendor"
              />
            </td>
            <td
              *ngIf="
                budgetTableTab !== 'Materials' && budgetTableTab !== 'Equipment'
              "
            >
              <input
                class="table-input"
                [(ngModel)]="editingItem!.trade"
                placeholder="Trade"
              />
            </td>

            <ng-container
              *ngIf="
                budgetTableTab === 'Materials' || budgetTableTab === 'Equipment'
              "
            >
              <td>
                <input
                  type="number"
                  class="table-input text-right"
                  [(ngModel)]="editingItem!.quantity"
                  (ngModelChange)="recalculateEstimatedCost(editingItem!)"
                  placeholder="0"
                />
              </td>
              <td>
                <input
                  class="table-input"
                  [(ngModel)]="editingItem!.unit"
                  placeholder="Unit"
                />
              </td>
              <td>
                <input
                  type="number"
                  class="table-input text-right"
                  [(ngModel)]="editingItem!.unitCost"
                  (ngModelChange)="recalculateEstimatedCost(editingItem!)"
                  placeholder="0.00"
                />
              </td>
            </ng-container>

            <ng-container *ngIf="budgetTableTab === 'Subcontractor'">
              <td>
                <input
                  type="number"
                  class="table-input text-right"
                  [(ngModel)]="editingItem!.quantity"
                  (ngModelChange)="recalculateEstimatedCost(editingItem!)"
                  placeholder="0"
                />
              </td>
              <td>
                <input
                  type="number"
                  class="table-input text-right"
                  [(ngModel)]="editingItem!.unitCost"
                  (ngModelChange)="recalculateEstimatedCost(editingItem!)"
                  placeholder="0.00"
                />
              </td>
            </ng-container>

            <td>
              <input
                type="number"
                class="table-input text-right"
                [(ngModel)]="editingItem!.estimatedCost"
                placeholder="0"
              />
            </td>
            <td>
              <input
                type="number"
                class="table-input text-right"
                [(ngModel)]="editingItem!.actualCost"
                placeholder="0"
              />
            </td>
            <td class="text-center">-</td>
            <td class="text-right text-muted">
              <input
                type="number"
                class="table-input text-right"
                [(ngModel)]="editingItem!.percentComplete"
                placeholder="0"
                min="0"
                max="100"
              />
            </td>
            <td class="text-right text-muted">
              <input
                type="number"
                class="table-input text-right"
                [(ngModel)]="editingItem!.forecastToComplete"
                placeholder="0"
              />
            </td>
            <td>
              <input
                class="table-input"
                [(ngModel)]="editingItem!.notes"
                placeholder="Notes"
              />
            </td>
            <td>
              <div class="action-buttons-row">
                <button
                  mat-icon-button
                  class="text-green"
                  (click)="saveEditLineItem()"
                  matTooltip="Save"
                >
                  <mat-icon>check</mat-icon>
                </button>
                <button
                  mat-icon-button
                  class="text-red"
                  (click)="cancelEditLineItem()"
                  matTooltip="Cancel"
                >
                  <mat-icon>close</mat-icon>
                </button>
              </div>
            </td>
          </ng-template>
        </tr>
      </tbody>
      <tfoot>
        <tr>
          <td></td>
          <td>TOTAL</td>
          <td
            *ngIf="
              budgetTableTab === 'Subcontractor' || budgetTableTab === 'all'
            "
          ></td>
          <td *ngIf="budgetTableTab !== 'Materials'"></td>
          <ng-container *ngIf="budgetTableTab === 'Materials'">
            <td></td>
            <td></td>
            <td></td>
          </ng-container>
          <td class="text-right">
            ${{ totalEstimated / 1000 | number: "1.0-0" }}K
          </td>
          <td class="text-right">
            ${{ totalActual / 1000 | number: "1.0-0" }}K
          </td>
          <td
            class="text-right"
            [ngClass]="variance >= 0 ? 'text-green' : 'text-red'"
          >
            {{ variance >= 0 ? "+" : "" }}${{
              variance / 1000 | number: "1.0-0"
            }}K
          </td>
          <td></td>
          <td class="text-right">
            ${{ totalForecast / 1000 | number: "1.0-0" }}K
          </td>
          <td></td>
          <td></td>
        </tr>
      </tfoot>
    </table>
  </div>
</mat-card>

<!-- Additional Sections -->
<div class="two-column-grid">
  <mat-card>
    <mat-card-header>
      <mat-card-title class="summary-header-title">
        <div style="display: flex; align-items: center; gap: 8px">
          <!-- Lucide Users Icon -->
          <svg
            xmlns="http://www.w3.org/2000/svg"
            width="24"
            height="24"
            viewBox="0 0 24 24"
            fill="none"
            stroke="currentColor"
            stroke-width="2"
            stroke-linecap="round"
            stroke-linejoin="round"
            class="text-primary"
          >
            <path d="M16 21v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2" />
            <circle cx="9" cy="7" r="4" />
            <path d="M22 21v-2a4 4 0 0 0-3-3.87" />
            <path d="M16 3.13a4 4 0 0 1 0 7.75" />
          </svg>
          Subcontractor Cost Summary
        </div>
      </mat-card-title>
    </mat-card-header>
    <mat-card-content>
      <div class="sub-list">
        <div class="sub-item" *ngFor="let sub of subcontractorSummary">
          <div>
            <p class="name">{{ sub.vendor || sub.trade || sub.item }}</p>
            <p class="draws">{{ sub.trade }}</p>
          </div>
          <div style="text-align: right">
            <p class="amount">${{ sub.actualCost | number: "1.0-0" }}</p>
            <p
              class="status"
              [ngClass]="
                getStatusColor(sub.estimatedCost, sub.forecastToComplete)
              "
            >
              {{ getVariance(sub) >= 0 ? "Under Budget" : "Over Budget" }}
            </p>
          </div>
        </div>
        <div
          *ngIf="subcontractorSummary.length === 0"
          class="text-muted text-center p-4"
        >
          No subcontractor costs recorded yet.
        </div>
      </div>
    </mat-card-content>
  </mat-card>

  <mat-card>
    <mat-card-header>
      <mat-card-title class="summary-header-title">
        <div style="display: flex; align-items: center; gap: 8px">
          <!-- Lucide FileText Icon -->
          <svg
            xmlns="http://www.w3.org/2000/svg"
            width="24"
            height="24"
            viewBox="0 0 24 24"
            fill="none"
            stroke="currentColor"
            stroke-width="2"
            stroke-linecap="round"
            stroke-linejoin="round"
            class="text-primary"
          >
            <path
              d="M14.5 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7.5L14.5 2z"
            />
            <polyline points="14 2 14 8 20 8" />
            <line x1="16" x2="8" y1="13" y2="13" />
            <line x1="16" x2="8" y1="17" y2="17" />
            <line x1="10" x2="8" y1="9" y2="9" />
          </svg>
          Recent Change Orders
        </div>
      </mat-card-title>
    </mat-card-header>
    <mat-card-content>
      <div class="sub-list">
        <div class="change-order-item">
          <div>
            <p class="title">HARDCODED CO-001: Additional Outlets</p>
            <p class="date">Approved • Jan 15, 2025</p>
          </div>
          <p class="amount text-red">+$3.2K</p>
        </div>
        <div class="change-order-item">
          <div>
            <p class="title">HARDCODED CO-002: Upgraded Fixtures</p>
            <p class="date">Approved • Jan 20, 2025</p>
          </div>
          <p class="amount text-red">+$5.8K</p>
        </div>
        <div class="change-order-item">
          <div>
            <p class="title">HARDCODED CO-003: Material Substitution</p>
            <p class="date">Approved • Jan 22, 2025</p>
          </div>
          <p class="amount text-green">-$2.1K</p>
        </div>
      </div>
    </mat-card-content>
  </mat-card>
</div>
