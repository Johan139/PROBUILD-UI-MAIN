<div class="find-work-container">
  <div class="tabs">
    <button (click)="setActiveTab('allJobs')" [class.active]="activeTab === 'allJobs'">All Jobs</button>
    <button (click)="setActiveTab('myBids')" [class.active]="activeTab === 'myBids'">My Bids</button>
  </div>

  <div *ngIf="filtersLoading" class="centered-spinner-container">
    <mat-spinner></mat-spinner>
  </div>

  <div *ngIf="!filtersLoading" class="unified-view">
    <div class="list-panel">
      <div class="list-container">
        <div class="search-container">
          <input type="text" placeholder="Search by keyword..." [(ngModel)]="searchTerm" (ngModelChange)="applyFilters()">
        </div>
        <div class="advanced-filters">
          <div>
            <label for="distance">Distance: {{ distance }} {{ distanceUnit }}</label>
            <input type="range" id="distance" min="0" max="100000" step="20" [(ngModel)]="distance" (ngModelChange)="applyFilters()">
          </div>
          <div class="filter-row">
            <button mat-icon-button (click)="toggleSortDirection()" class="sort-direction-button">
              <mat-icon>{{ sortDirection === 'asc' ? 'arrow_upward' : 'arrow_downward' }}</mat-icon>
            </button>
            <mat-form-field>
              <mat-label>Sort by</mat-label>
              <mat-select [(ngModel)]="sortBy" (ngModelChange)="sortJobs()">
                <mat-option value="distance">Distance</mat-option>
                <mat-option value="startDate">Start Date</mat-option>
                <mat-option value="postedDate">Recently Added</mat-option>
              </mat-select>
            </mat-form-field>
            <mat-form-field>
              <mat-label>Trades</mat-label>
              <mat-select multiple [(ngModel)]="selectedTrades" (ngModelChange)="applyFilters()">
                <mat-option *ngFor="let trade of allTrades" [value]="trade">
                  {{trade | titlecase}} ({{ tradeCounts[trade] || 0 }})
                </mat-option>
              </mat-select>
            </mat-form-field>
            <mat-form-field>
              <mat-label>Job Type</mat-label>
              <mat-select multiple [(ngModel)]="selectedJobTypes" (ngModelChange)="applyFilters()">
                <mat-option *ngFor="let type of allJobTypes" [value]="type.value">{{type.viewValue}}</mat-option>
              </mat-select>
            </mat-form-field>
            <button mat-button class="clear-filters-btn" (click)="clearFilters()">Reset</button>
          </div>
        </div>
        <div *ngIf="activeTab === 'allJobs'">
          <h2>All Jobs ({{ filteredJobs.length }})</h2>
          <div *ngIf="jobsLoading" class="loading">Loading jobs...</div>
          <div *ngIf="!jobsLoading && jobs.length === 0" class="no-jobs">No jobs available</div>
          <div *ngIf="!jobsLoading && filteredJobs.length === 0 && jobs.length > 0" class="no-jobs">
            No jobs found with your current filters
          </div>
          <ul class="job-list" *ngIf="!jobsLoading && filteredJobs.length > 0">
            <li *ngFor="let job of dataSource.connect() | async; trackBy: trackByJobId" class="job-item" (mouseenter)="highlightMarker(job.jobId)" (mouseleave)="unhighlightMarker(job.jobId)" (click)="onJobClick(job)">
              <app-job-card
                [job]="job"
                [userTrade]="userTrade"
                [quote]="getQuoteForJob(job.jobId)"
                [bid]="getBidForJob(job.jobId)"
                (viewQuote)="onViewQuote($event)"
                (withdrawBid)="onWithdrawBid($event)"
                (editBid)="onEditBid($event)"
                [showBidButton]="!getQuoteForJob(job.jobId) && !getBidForJob(job.jobId)">
              </app-job-card>
            </li>
          </ul>
          <mat-paginator [length]="filteredJobs.length" [pageSizeOptions]="[5, 10, 20]" showFirstLastButtons></mat-paginator>
        </div>

        <div *ngIf="activeTab === 'myBids'">
          <h2>My Bids ({{ myBidsDataSource.data.length }})</h2>
          <div class="filter-buttons">
            <button mat-raised-button [color]="quoteStatusFilter === 'All' ? 'primary' : ''" (click)="quoteStatusFilter = 'All'; applyQuoteFilter()">All</button>
            <button mat-raised-button [color]="quoteStatusFilter === 'Draft' ? 'primary' : ''" (click)="quoteStatusFilter = 'Draft'; applyQuoteFilter()">Draft</button>
            <button mat-raised-button [color]="quoteStatusFilter === 'Submitted' ? 'primary' : ''" (click)="quoteStatusFilter = 'Submitted'; applyQuoteFilter()">Submitted</button>
            <button mat-raised-button [color]="quoteStatusFilter === 'Rejected' ? 'primary' : ''" (click)="quoteStatusFilter = 'Rejected'; applyQuoteFilter()">Rejected</button>
          </div>
          <div *ngIf="bidsLoading" class="loading">Loading your bids...</div>
          <div *ngIf="!bidsLoading && myBidsDataSource.data.length === 0" class="no-jobs">You haven't placed any bids yet</div>
          <ul class="job-list" *ngIf="!bidsLoading && myBidsDataSource.data.length > 0">
            <li *ngFor="let bid of myBidsDataSource.connect() | async; trackBy: trackByBidId" class="job-item">
              <app-job-card *ngIf="bid.job" [job]="bid.job" [bid]="bid" [quote]="getQuoteForBid(bid)" (viewQuote)="onViewQuote($event)" (withdrawBid)="onWithdrawBid($event)" (editBid)="onEditBid($event)" [userTrade]="userTrade" [showBidButton]="false">
              </app-job-card>
            </li>
          </ul>
          <mat-paginator [length]="myBidsDataSource.data.length" [pageSizeOptions]="[5, 10, 20]" showFirstLastButtons></mat-paginator>
        </div>
      </div>
    </div>
    <div class="map-panel">
      <div class="map-view-wrapper">
        <div class="map-container" [class.with-panel]="selectedJob">
          <!-- Loading state -->
          <div *ngIf="isMapLoading && !mapLoadError" class="map-loading">
            <div class="loading-spinner"></div>
            <p>Loading map...</p>
          </div>

        <!-- Error state -->
        <div *ngIf="mapLoadError" class="map-error">
          <p>Failed to load Google Maps. Please check your API key and internet connection.</p>
          <button (click)="retryMapLoad()" class="retry-btn">Retry</button>
        </div>

        <!-- Map component -->
        <google-map
          *ngIf="(isApiLoaded$ | async) && !isMapLoading && !mapLoadError"
          height="80%"
          width="100%"
          [center]="center"
          [zoom]="zoom"
          [options]="mapOptions"
          (mapInitialized)="onMapInitialized($event)">
        </google-map>
        </div>
      </div>
    </div>
  </div>
</div>

