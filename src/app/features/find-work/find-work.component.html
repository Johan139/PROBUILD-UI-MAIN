<div class="find-work-container">
  <div class="tabs">
    <button (click)="setActiveTab('allJobs')" [class.active]="activeTab === 'allJobs'">All Jobs</button>
    <button (click)="setActiveTab('myBids')" [class.active]="activeTab === 'myBids'">My Bids</button>
  </div>

  <div class="unified-view">
    <div class="list-panel">
      <div class="list-container">
        <div class="search-container">
          <input type="text" placeholder="Search by keyword..." [(ngModel)]="searchTerm" (ngModelChange)="applyFilters()">
        </div>
        <div class="advanced-filters">
          <div>
            <label for="distance">Distance: {{ distance }} {{ distanceUnit }}</label>
            <input type="range" id="distance" min="0" max="100000" step="20" [(ngModel)]="distance" (ngModelChange)="applyFilters()"> <!-- changed max to 100000 to test TODO: change it back to something that makes sense -->
          </div>
          <div class="filter-row">
            <button mat-icon-button (click)="toggleSortDirection()" class="sort-direction-button">
              <mat-icon>{{ sortDirection === 'asc' ? 'arrow_upward' : 'arrow_downward' }}</mat-icon>
            </button>
            <mat-form-field>
              <mat-label>Sort by</mat-label>
              <mat-select [(ngModel)]="sortBy" (ngModelChange)="sortJobs()">
                <mat-option value="distance">Distance</mat-option>
                <mat-option value="startDate">Start Date</mat-option>
                <mat-option value="postedDate">Recently Added</mat-option>
              </mat-select>
            </mat-form-field>
            <mat-form-field>
              <mat-label>Trades</mat-label>
              <mat-select multiple [(ngModel)]="selectedTrades" (ngModelChange)="applyFilters()">
                <mat-option *ngFor="let trade of allTrades" [value]="trade">
                  {{trade | titlecase}} ({{ tradeCounts[trade] || 0 }})
                </mat-option>
              </mat-select>
            </mat-form-field>
            <mat-form-field>
              <mat-label>Job Type</mat-label>
              <mat-select multiple [(ngModel)]="selectedJobTypes" (ngModelChange)="applyFilters()">
                <mat-option *ngFor="let type of allJobTypes" [value]="type">{{type}}</mat-option>
              </mat-select>
            </mat-form-field>
            <button mat-button class="clear-filters-btn" (click)="clearFilters()">Clear</button>
          </div>
        </div>
        <div *ngIf="activeTab === 'allJobs'">
          <h2>All Jobs ({{ filteredJobs.length }})</h2>
          <div *ngIf="jobsLoading" class="loading">Loading jobs...</div>
          <div *ngIf="!jobsLoading && jobs.length === 0" class="no-jobs">No jobs available</div>
          <div *ngIf="!jobsLoading && filteredJobs.length === 0 && jobs.length > 0" class="no-jobs">
            No jobs found with your current filters
          </div>
          <ul class="job-list" *ngIf="!jobsLoading && filteredJobs.length > 0">
            <li *ngFor="let job of dataSource.connect() | async; trackBy: trackByJobId" class="job-item" (mouseenter)="highlightMarker(job.jobId)" (mouseleave)="unhighlightMarker(job.jobId)" (click)="onJobClick(job)">
              <div class="job-header">
                <h3>{{ job.projectName }}</h3>
                <div class="client-info">
                  <span *ngIf="job.clientCompanyName">{{ job.clientCompanyName }} ({{ job.clientName }})</span>
                  <span *ngIf="!job.clientCompanyName">{{ job.clientName }}</span>
                  <ng-container *ngIf="job.clientRating; else newClient">
                    <mat-icon *ngFor="let star of getStarRating(job.clientRating)" class="gold-star">{{ star }}</mat-icon>
                    <span>({{ job.clientRating.toFixed(1) }})</span>
                  </ng-container>
                  <ng-template #newClient>
                    <span class="new-tag" matTooltip="This user is new to the system and does not have a rating yet">New</span>
                  </ng-template>
                </div>
              </div>
              <p class="job-description"><strong>Job Type:</strong> {{ job.jobType | titlecase }}</p>
              <div class="job-location">
                <span>üìç {{ job.address || job.city + ', ' + job.state }} <span class="job-distance" *ngIf="job.distance">- {{ job.distance.toFixed(2) }} {{ distanceUnit }} away</span></span>
              </div>
              <div class="job-dates">
                <p class="job-posted-date" *ngIf="job.biddingStartDate"><strong>Posted:</strong> {{ job.biddingStartDate | date }}</p>
                <div class="job-expected-dates">
                  <span class="provisional-label">Provisional:</span>
                  <span *ngIf="job.potentialStartDate"><strong>Start:</strong> {{ job.potentialStartDate | date }}</span>
                  <span *ngIf="job.potentialEndDate"><strong>End:</strong> {{ job.potentialEndDate | date }}</span>
                  <span *ngIf="job.durationInDays"><strong>Duration:</strong> {{ job.durationInDays }} days</span>
                </div>
              </div>

              <div class="job-trades">
                <span *ngFor="let trade of job.trades" class="trade-pill" [class.match]="trade === userTrade" [matTooltip]="getTradeTooltip(trade)" [class.greyed-out]="!hasTradeMatch(job)">
                  {{ trade | titlecase }}
                </span>
              </div>
              <p *ngIf="!hasTradeMatch(job)" class="trade-warning">
                Your trade does not match up to anything required by this job
              </p>
            </li>
          </ul>
          <mat-paginator [pageSizeOptions]="[5, 10, 20]" showFirstLastButtons></mat-paginator>
        </div>

        <div *ngIf="activeTab === 'myBids'">
          <h2>My Bids ({{ myBids.length }})</h2>
          <div *ngIf="bidsLoading" class="loading">Loading your bids...</div>
          <div *ngIf="!bidsLoading && myBids.length === 0" class="no-jobs">You haven't placed any bids yet</div>
          <ul class="job-list" *ngIf="!bidsLoading && myBids.length > 0">
            <li *ngFor="let bid of myBids; trackBy: trackByBidId" class="job-item">
              <div class="job-header">
                <h3>{{ bid.job?.projectName }}</h3>
              </div>
               <div class="job-location">
                <span *ngIf="bid.job">üìç {{ bid.job.address || '' }} <span class="job-distance" *ngIf="bid.job.distance">- {{ bid.job.distance.toFixed(2) }} {{ distanceUnit }} away</span></span>
              </div>
              <p class="job-description">{{ bid.job?.jobType | titlecase }}</p>
              <div class="job-dates">
                <div class="job-expected-dates">
                  <span class="provisional-label">Provisional:</span>
                  <span *ngIf="bid.job?.potentialStartDate"><strong>Start:</strong> {{ bid.job?.potentialStartDate | date }}</span>
                  <span *ngIf="bid.job?.potentialEndDate"><strong>End:</strong> {{ bid.job?.potentialEndDate | date }}</span>
                  <span *ngIf="bid.job?.durationInDays"><strong>Duration:</strong> {{ bid.job?.durationInDays }} days</span>
                </div>
              </div>
              <div class="job-trades">
                <span *ngFor="let trade of bid.job?.trades" class="trade-pill" [class.match]="trade === userTrade" [matTooltip]="getTradeTooltip(trade)" [class.greyed-out]="bid.job && !hasTradeMatch(bid.job)">
                  {{ trade | titlecase }}
                </span>
              </div>
              <p *ngIf="bid.job && !hasTradeMatch(bid.job)" class="trade-warning">
                Your trade does not match up to anything required by this job.
              </p>
              <div class="bid-status">
                <span class="status-badge">{{ bid.status }}</span>
              </div>
            </li>
          </ul>
          <mat-paginator [pageSizeOptions]="[5, 10, 20]" showFirstLastButtons></mat-paginator>
        </div>
      </div>
    </div>
    <div class="map-panel">
      <div class="map-view-wrapper">
        <div class="map-container" [class.with-panel]="selectedJob">
          <!-- Loading state -->
          <div *ngIf="isMapLoading && !mapLoadError" class="map-loading">
            <div class="loading-spinner"></div>
            <p>Loading map...</p>
          </div>

        <!-- Error state -->
        <div *ngIf="mapLoadError" class="map-error">
          <p>Failed to load Google Maps. Please check your API key and internet connection.</p>
          <button (click)="retryMapLoad()" class="retry-btn">Retry</button>
        </div>

        <!-- Map component -->
        <google-map
          *ngIf="(isApiLoaded$ | async) && !isMapLoading && !mapLoadError"
          height="80%"
          width="100%"
          [center]="center"
          [zoom]="zoom"
          [options]="mapOptions"
          (mapInitialized)="onMapInitialized($event)">
        </google-map>
        </div>
      </div>
    </div>
  </div>
</div>

