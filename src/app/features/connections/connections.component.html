<div class="connections-container">
  <h1>User Directory</h1>

  <mat-card>
    <mat-card-content>
      <mat-form-field appearance="fill">
        <mat-label>Search for users</mat-label>
        <input matInput (keyup)="applyFilter($event)" placeholder="e.g., John Doe, Electrician">
        <mat-icon matSuffix>search</mat-icon>
      </mat-form-field>
    </mat-card-content>
  </mat-card>

  <mat-tab-group>
    <mat-tab label="Search Results">
      <ng-template matTabContent>
        <div class="mat-elevation-z8">
          <table mat-table [dataSource]="dataSource">

            <!-- Name Column -->
            <ng-container matColumnDef="name">
              <th mat-header-cell *matHeaderCellDef> Name </th>
              <td mat-cell *matCellDef="let user"> {{user.firstName}} {{user.lastName}} </td>
            </ng-container>

            <!-- User Type Column -->
            <ng-container matColumnDef="type">
              <th mat-header-cell *matHeaderCellDef> Type </th>
              <td mat-cell *matCellDef="let user"> {{user.userType}} </td>
            </ng-container>

            <!-- Company Name Column -->
            <ng-container matColumnDef="companyName">
              <th mat-header-cell *matHeaderCellDef> Company </th>
              <td mat-cell *matCellDef="let user"> {{user.companyName}} </td>
            </ng-container>

            <!-- Email Column -->
            <ng-container matColumnDef="email">
              <th mat-header-cell *matHeaderCellDef> Email </th>
              <td mat-cell *matCellDef="let user"> {{user.email}} </td>
            </ng-container>

            <!-- Phone Number Column -->
            <ng-container matColumnDef="phoneNumber">
              <th mat-header-cell *matHeaderCellDef> Phone </th>
              <td mat-cell *matCellDef="let user"> {{user.phoneNumber}} </td>
            </ng-container>

            <!-- Construction Type Column -->
            <ng-container matColumnDef="constructionType">
              <th mat-header-cell *matHeaderCellDef> Construction Type </th>
              <td mat-cell *matCellDef="let user"> {{user.constructionType}} </td>
            </ng-container>

            <!-- Trade Column -->
            <ng-container matColumnDef="trade">
              <th mat-header-cell *matHeaderCellDef> Trade </th>
              <td mat-cell *matCellDef="let user"> {{user.trade}} </td>
            </ng-container>

            <!-- Supplier Type Column -->
            <ng-container matColumnDef="supplierType">
              <th mat-header-cell *matHeaderCellDef> Supplier Type </th>
              <td mat-cell *matCellDef="let user"> {{user.supplierType}} </td>
            </ng-container>

            <!-- Products Offered Column -->
            <ng-container matColumnDef="productsOffered">
              <th mat-header-cell *matHeaderCellDef> Products Offered </th>
              <td mat-cell *matCellDef="let user"> {{user.productsOffered}} </td>
            </ng-container>

            <!-- Country Column -->
            <ng-container matColumnDef="country">
              <th mat-header-cell *matHeaderCellDef> Country </th>
              <td mat-cell *matCellDef="let user"> {{user.country}} </td>
            </ng-container>

            <!-- City Column -->
            <ng-container matColumnDef="city">
              <th mat-header-cell *matHeaderCellDef> City </th>
              <td mat-cell *matCellDef="let user"> {{user.city}} </td>
            </ng-container>

            <!-- Action Column -->
            <ng-container matColumnDef="action">
              <th mat-header-cell *matHeaderCellDef></th>
              <td mat-cell *matCellDef="let user">
                <div class="action-container" *ngIf="user.id !== currentUserId">
                  <ng-container *ngIf="isRequestReceived(user.id); else notReceived">
                    <button mat-flat-button color="accent" class="action-button"
                            (mouseover)="hoveredUserId = user.id"
                            (mouseout)="hoveredUserId = null"
                            (click)="acceptConnectionRequest(user.id)">
                      <mat-icon>{{ hoveredUserId === user.id ? 'check' : 'person_add' }}</mat-icon>
                      {{ hoveredUserId === user.id ? 'Accept Request' : 'Request Received' }}
                    </button>
                  </ng-container>
                  <ng-template #notReceived>
                    <ng-container *ngIf="!isRequestSent(user.id); else requestSentButton">
                      <button *ngIf="user.isInSystem" mat-stroked-button color="primary" class="action-button" (click)="sendConnectionRequest(user.id)">
                        <mat-icon>person_add</mat-icon>
                        Connect
                      </button>
                    </ng-container>
                  </ng-template>
                  <ng-template #requestSentButton>
                    <button mat-flat-button color="primary" class="action-button"
                            (mouseover)="hoveredUserId = user.id"
                            (mouseout)="hoveredUserId = null"
                            (click)="cancelConnectionRequest(user.id)"
                            [class.cancel-button]="hoveredUserId === user.id">
                      <mat-icon>{{ hoveredUserId === user.id ? 'close' : 'check' }}</mat-icon>
                      {{ hoveredUserId === user.id ? 'Cancel Request' : 'Request Sent' }}
                    </button>
                  </ng-template>
                  <ng-container *ngIf="user.isInSystem; else greyLogo">
                    <img src="assets/roundedlogo.png" alt="Probuild Logo" class="probuild-logo">
                  </ng-container>
                  <ng-template #greyLogo>
                    <img src="assets/roundedlogogrey.png" alt="Probuild Logo Grayscale" class="probuild-logo">
                  </ng-template>
                </div>
              </td>
            </ng-container>

            <tr mat-header-row *matHeaderRowDef="displayedColumns"></tr>
            <tr mat-row *matRowDef="let row; columns: displayedColumns;"></tr>
          </table>
          <div *ngIf="showInviteMessage" class="invite-message">
            <p>We couldn't find the person you're looking for, do you want to invite them to join ProBuild?</p>
            <button mat-icon-button (click)="openInvitationDialog()">
              <mat-icon>check_circle</mat-icon>
            </button>
          </div>
          <mat-paginator [pageSizeOptions]="[20, 50, 100]" showFirstLastButtons></mat-paginator>
        </div>
      </ng-template>
    </mat-tab>

    <mat-tab label="My Connections">
      <ng-template matTabContent>
        <div class="mat-elevation-z8">
          <table mat-table [dataSource]="connectionsDataSource">
            <ng-container matColumnDef="name">
              <th mat-header-cell *matHeaderCellDef> Name </th>
              <td mat-cell *matCellDef="let conn"> {{ conn.user?.firstName || conn.firstName }} {{ conn.user?.lastName || conn.lastName }} </td>
            </ng-container>
            <ng-container matColumnDef="email">
              <th mat-header-cell *matHeaderCellDef> Email </th>
              <td mat-cell *matCellDef="let conn"> {{ conn.user?.email || conn.otherUserEmail }} </td>
            </ng-container>
            <ng-container matColumnDef="status">
              <th mat-header-cell *matHeaderCellDef> Status </th>
              <td mat-cell *matCellDef="let conn">
                <ng-container *ngIf="conn.isInSystem">
                  <ng-container *ngIf="conn.status === 'PENDING'">
                    {{ conn.requesterId === currentUserId ? 'Request Sent' : 'Request Received' }}
                  </ng-container>
                  <ng-container *ngIf="conn.status === 'ACCEPTED'">
                    Connected
                  </ng-container>
                </ng-container>
                <ng-container *ngIf="!conn.isInSystem">
                  Invited
                </ng-container>
              </td>
            </ng-container>
            <ng-container matColumnDef="action">
              <th mat-header-cell *matHeaderCellDef></th>
              <td mat-cell *matCellDef="let conn">
                <ng-container *ngIf="conn.status === 'PENDING'">
                  <button *ngIf="conn.requesterId === currentUserId" mat-stroked-button color="warn" (click)="cancelConnectionRequest(conn.otherUserId)">Cancel</button>
                  <button *ngIf="conn.receiverId === currentUserId" mat-stroked-button color="primary" (click)="acceptConnectionRequest(conn.id)">Accept</button>
                  <button *ngIf="conn.receiverId === currentUserId" mat-stroked-button color="warn" (click)="declineConnectionRequest(conn.id)">Decline</button>
                </ng-container>
                <button *ngIf="conn.status === 'ACCEPTED'" mat-stroked-button color="warn" (click)="removeConnection(conn.id)">Remove</button>
                <img [src]="conn.isInSystem ? 'assets/roundedlogo.png' : 'assets/roundedlogogrey.png'" alt="Probuild Logo" class="probuild-logo">
              </td>
            </ng-container>
            <tr mat-header-row *matHeaderRowDef="connectionsColumns"></tr>
            <tr mat-row *matRowDef="let row; columns: connectionsColumns;"></tr>
          </table>
        </div>
      </ng-template>
    </mat-tab>

  </mat-tab-group>
</div>

