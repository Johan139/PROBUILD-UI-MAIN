<div *ngIf="isLoading">
  <app-loader></app-loader>
</div>

<div class="dashboard-container">
  <div class="welcome-header">
    <h2>Welcome to ProBuild AI</h2>
    <p>Manage your construction projects with AI-powered tools</p>

          <div *ngIf="teams.length > 1" class="team-picker">
          <mat-form-field appearance="outline">
            <mat-label>Select Team</mat-label>
            <mat-select [(ngModel)]="selectedTeam" name="team">
              <mat-option *ngFor="let team of teams" [value]="team">{{ team.inviterName }}</mat-option>
            </mat-select>
          </mat-form-field>
        </div>
  </div>

  <div class="quick-actions">
    <h3>Quick Actions</h3>
    <div class="actions-container">
      <button mat-flat-button class="btn-primary quick-action-btn" (click)="navigateToJobs()">
        <mat-icon>add</mat-icon>
        Create New Project
      </button>
      <button class="btn-outline quick-action-btn" (click)="navigateToProjects()">
        <mat-icon>list</mat-icon>
        View All Projects
      </button>
      <button class="btn-outline quick-action-btn" (click)="navigateToCalendar()">
        <mat-icon>calendar_today</mat-icon>
        View Calendar
      </button>
    </div>
  </div>

  <section class="card action-points-card">
    <mat-card>
      <mat-card-header>
        <mat-card-title><strong>Action Points</strong></mat-card-title>
      </mat-card-header>
      <mat-card-content>
        <mat-divider class="section-divider"></mat-divider>

        <p *ngIf="notes.length === 0" class="muted">No notes assigned to you yet.</p>

        <div class="table-wrap" *ngIf="notes.length > 0">
          <mat-table [dataSource]="notes" class="job-table">
            <!-- Project Column -->
            <ng-container matColumnDef="project">
              <mat-header-cell *matHeaderCellDef>Project</mat-header-cell>
              <mat-cell *matCellDef="let note" class="wrap">{{ note.projectName }}</mat-cell>
            </ng-container>

            <!-- Task Column -->
            <ng-container matColumnDef="task">
              <mat-header-cell *matHeaderCellDef>Task</mat-header-cell>
              <mat-cell *matCellDef="let note" class="wrap">{{ note.subtaskName }}</mat-cell>
            </ng-container>

            <!-- Created Column -->
            <ng-container matColumnDef="created">
              <mat-header-cell *matHeaderCellDef>Created</mat-header-cell>
              <mat-cell *matCellDef="let note">{{ note.createdAt | date:'short' }}</mat-cell>
            </ng-container>

            <!-- Status Column -->
            <ng-container matColumnDef="status">
              <mat-header-cell *matHeaderCellDef>Status</mat-header-cell>
              <mat-cell *matCellDef="let note">
                <span class="badge"
                      [ngClass]="{
                        'is-archived': note.status === 'Archived',
                        'is-approved': note.status === 'Approved',
                        'is-rejected': note.status === 'Rejected',
                        'is-pending': note.status === 'Pending'
                      }">{{ note.status }}</span>
              </mat-cell>
            </ng-container>

            <!-- Action Column -->
            <ng-container matColumnDef="action">
              <mat-header-cell *matHeaderCellDef>Action</mat-header-cell>
              <mat-cell *matCellDef="let note">
                <button class="btn-primary" mat-button (click)="openNoteDialog(note)"
                        [disabled]="openingNoteId === note.notes[0].id">
                  {{ openingNoteId === note.notes[0].id ? 'Viewingâ€¦' : 'View' }}
                </button>
              </mat-cell>
            </ng-container>

            <mat-header-row *matHeaderRowDef="notesDisplayedColumns"></mat-header-row>
            <mat-row *matRowDef="let row; columns: notesDisplayedColumns;"></mat-row>
          </mat-table>
        </div>
      </mat-card-content>
    </mat-card>
  </section>

  <div class="recent-projects">
    <div class="carousel-header">
      <h3>Recent Projects</h3>
      <div class="view-toggle">
        <button mat-icon-button (click)="toggleProjectView('grid')" [class.active]="projectView === 'grid'"
                matTooltip="Grid View" [matTooltipShowDelay]="500">
          <mat-icon>grid_view</mat-icon>
        </button>
        <button mat-icon-button (click)="toggleProjectView('list')" [class.active]="projectView === 'list'"
                matTooltip="List View" [matTooltipShowDelay]="500">
          <mat-icon>list</mat-icon>
        </button>
      </div>
      <div class="carousel-controls" *ngIf="projectView === 'grid'">
        <button mat-icon-button (click)="prevProject()" [disabled]="currentIndex === 0">
          <mat-icon>chevron_left</mat-icon>
        </button>
        <button mat-icon-button (click)="nextProject()" [disabled]="currentIndex >= projects.length - 3">
          <mat-icon>chevron_right</mat-icon>
        </button>
      </div>
    </div>
    <div *ngIf="projectView === 'grid'" class="projects-carousel">
        <app-project-card *ngFor="let project of visibleProjects" [project]="project" (onView)="loadJob($event)" (onArchive)="archiveJob($event)"></app-project-card>
    </div>
    <div *ngIf="projectView === 'list'">
      <app-projects-table
        [projects]="projects"
        (onView)="loadJob($event)"
        (onArchive)="archiveJob($event)">
      </app-projects-table>
    </div>
    <!-- Documents Dialog -->
<ng-template #documentsDialog>
  <div class="documents-dialog">
    <h2 mat-dialog-title>Quote Documents</h2>
    <mat-dialog-content>
      <!-- Show loading indicator while fetching documents -->
      <div *ngIf="isDocumentsLoading" class="loading-documents">
        <app-loader></app-loader>
        <p>Loading documents...</p>
      </div>
      <!-- Show content only when not loading -->
      <div *ngIf="!isDocumentsLoading">
        <div *ngIf="documents.length === 0 && !documentsError" class="no-documents">
          <p>No documents available for this quote.</p>
        </div>
        <div *ngIf="documentsError" class="no-documents">
          <p>{{documentsError}}</p>
        </div>
        <div *ngIf="documents.length > 0" class="documents-list">
          <div class="document-item" *ngFor="let doc of documents; let i = index">
            <div class="document-info">
              <span class="document-name">{{doc.name}}</span>
              <span class="document-meta">{{doc.type}} - {{doc.size | filesize}}</span>
            </div>
            <button class="view-btn" mat-raised-button (click)="viewDocument(doc)">
              View
            </button>
          </div>
        </div>
      </div>
    </mat-dialog-content>
    <mat-dialog-actions>
      <button class="submit-btn" mat-raised-button (click)="closeDocumentsDialog()">Close</button>
    </mat-dialog-actions>
  </div>
</ng-template>

<!-- Approval Reason Dialog -->
<ng-template #approvalReasonDialog>
  <div class="note-detail-dialog">
    <h2 mat-dialog-title>Approval Reason</h2>

    <mat-dialog-content>
      <div
        class="note-text-box"
        contenteditable="true"
        (input)="onApprovalReasonChanged($event)"
        placeholder="Enter your approval reason here...">
      </div>
    </mat-dialog-content>

    <mat-dialog-actions align="end">
      <button mat-raised-button color="primary" class="submit-btn delete-btn" (click)="submitApproval()">Submit</button>
      <button mat-raised-button color="warn" class="submit-btn delete-btn" (click)="cancelApproval()">Cancel</button>
    </mat-dialog-actions>
  </div>

</ng-template>
  </div>
</div>
