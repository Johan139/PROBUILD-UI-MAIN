<div *ngIf="isLoading">
  <app-loader></app-loader>
</div>

<div class="container">
  <div class="row">
    <div class="column">
      <mat-card>
        <mat-card-header>
          <mat-card-title>Welcome to Your ProBuildAI Dashboard</mat-card-title>
        </mat-card-header>
        <mat-card-content>
          <div *ngIf="teams.length > 1">
            <mat-form-field>
              <mat-label>Select Team</mat-label>
              <mat-select [(ngModel)]="selectedTeam" name="team">
                <mat-option *ngFor="let team of teams" [value]="team">{{ team.inviterName }}</mat-option>
              </mat-select>
            </mat-form-field>
          </div>
          <mat-divider></mat-divider>

          <p *ngIf="isSubContractor">
            As a {{userType}}, manage your construction projects efficiently with our comprehensive tools.
            Track progress, create job quotes, and stay organized all in one place.
          </p>
          <p *ngIf="!isSubContractor">
            Welcome to ProBuildAI! Explore our tools to streamline your project management needs.
          </p>

          <div class="action-buttons">
            <!-- <button class="submit-btn delete-btn" mat-raised-button (click)="navigateToProjects()">View Projects</button> -->
            <button class="submit-btn delete-btn" mat-raised-button (click)="navigateToJobs()">View And Create Jobs</button>
          </div>

        </mat-card-content>
      </mat-card>
    </div>

    <div class="column">
      <mat-card class="mat-card-custom">
        <mat-card-header>
          <mat-card-title>Action Points</mat-card-title>
        </mat-card-header>
        <mat-card-content>
          <mat-divider></mat-divider>

          <div *ngIf="notes.length === 0">
            <p>No notes assigned to you yet.</p>
          </div>

          <div class="action-points-wrapper">
            <table class="themed-table action-points-table">
              <thead>
                <tr>
                  <th>Project</th>
                  <th>Task</th>
                  <th>Created</th>
                  <th>Status</th>
                  <th>Action</th>
                </tr>
              </thead>
              <tbody>
                <tr *ngFor="let group of notes">
                  <td style="white-space: normal; word-break: break-word;">{{group.projectName}}</td>
                  <td style="white-space: normal; word-break: break-word;">
                    {{ group.subtaskName }}
                  </td>
                  <td style="white-space: normal; word-break: break-word;">{{group.createdAt | date:'short'}}</td>
                  <td style="white-space: normal; word-break: break-word;">
                   <span [ngClass]="{
                     'status-approved': group.notes[0].approved,
                     'status-rejected': group.notes[0].rejected
                   }">
                     {{ getStatus(group.notes[0]) }}
                   </span>
                  </td>
                  <td>
                    <button class="submit-btn delete-btn" (click)="openNoteDialog(group)" mat-raised-button>View</button>
                  </td>
                </tr>
              </tbody>
            </table>
          </div>

        </mat-card-content>
      </mat-card>
    </div>

    <div class="job-progress-panel">
      <mat-card>
        <mat-card-header>
          <mat-card-title>Job Progress</mat-card-title>
        </mat-card-header>
        <mat-card-content>
          <mat-divider></mat-divider>
          <div *ngIf="jobsLoading">
            <p>Loading jobs...</p>
          </div>
          <div *ngIf="!jobsLoading && userJobs.length === 0">
            <p>No jobs assigned to you yet.</p>
          </div>
          <div class="job-scroll-container" *ngIf="userJobs.length > 0">
            <mat-table [dataSource]="userJobs" class="mat-elevation-z8">
              <!-- Project Column -->
              <ng-container matColumnDef="project">
                <mat-header-cell *matHeaderCellDef>Project</mat-header-cell>
                <mat-cell *matCellDef="let job">{{ job.projectName }}</mat-cell>
              </ng-container>

              <!-- Created Column -->
              <ng-container matColumnDef="created">
                <mat-header-cell *matHeaderCellDef>Created</mat-header-cell>
                <mat-cell *matCellDef="let job">{{ job.createdAt | date: 'shortDate' }}</mat-cell>
              </ng-container>

              <!-- Progress Column -->
              <ng-container matColumnDef="progress">
                <mat-header-cell *matHeaderCellDef>Progress</mat-header-cell>
                <mat-cell *matCellDef="let job">
                  <div class="job-progress-bar">
                    <div class="progress-fill" [style.width.%]="job.progress"></div>
                  </div>
                  <span class="progress-percent">{{ job.progress }}%</span>
                </mat-cell>
              </ng-container>

              <!-- Actions Column -->
              <ng-container matColumnDef="actions">
                <mat-header-cell *matHeaderCellDef></mat-header-cell>
                <mat-cell *matCellDef="let job">
                  <button mat-icon-button [matMenuTriggerFor]="menu">
                    <mat-icon>more_vert</mat-icon>
                  </button>
                  <mat-menu #menu="matMenu">
                    <button mat-menu-item (click)="loadJob(job.id)">View Job</button>
                    <button mat-menu-item [disabled]="job.progress !== 100" (click)="archiveJob(job.id)">
                      Archive Job
                    </button>
                  </mat-menu>
                </mat-cell>
              </ng-container>

              <mat-header-row *matHeaderRowDef="jobDisplayedColumns"></mat-header-row>
              <mat-row *matRowDef="let row; columns: jobDisplayedColumns;"></mat-row>
            </mat-table>
          </div>
        </mat-card-content>
      </mat-card>
    </div>
  </div>
</div>

<!-- Documents Dialog -->
<ng-template #documentsDialog>
  <div class="documents-dialog">
    <h2 mat-dialog-title>Quote Documents</h2>
    <mat-dialog-content>
      <!-- Show loading indicator while fetching documents -->
      <div *ngIf="isDocumentsLoading" class="loading-documents">
        <app-loader></app-loader>
        <p>Loading documents...</p>
      </div>
      <!-- Show content only when not loading -->
      <div *ngIf="!isDocumentsLoading">
        <div *ngIf="documents.length === 0 && !documentsError" class="no-documents">
          <p>No documents available for this quote.</p>
        </div>
        <div *ngIf="documentsError" class="no-documents">
          <p>{{documentsError}}</p>
        </div>
        <div *ngIf="documents.length > 0" class="documents-list">
          <div class="document-item" *ngFor="let doc of documents; let i = index">
            <div class="document-info">
              <span class="document-name">{{doc.name}}</span>
              <span class="document-meta">{{doc.type}} - {{doc.size | filesize}}</span>
            </div>
            <button class="view-btn" mat-raised-button (click)="viewDocument(doc)">
              View
            </button>
          </div>
        </div>
      </div>
    </mat-dialog-content>
    <mat-dialog-actions>
      <button class="submit-btn" mat-raised-button (click)="closeDocumentsDialog()">Close</button>
    </mat-dialog-actions>
  </div>
</ng-template>

<!-- Approval Reason Dialog -->
<ng-template #approvalReasonDialog>
  <div class="note-detail-dialog">
    <h2 mat-dialog-title>Approval Reason</h2>

    <mat-dialog-content>
      <div
        class="note-text-box"
        contenteditable="true"
        (input)="onApprovalReasonChanged($event)"
        placeholder="Enter your approval reason here...">
      </div>
    </mat-dialog-content>

    <mat-dialog-actions align="end">
      <button mat-raised-button color="primary" class="submit-btn delete-btn" (click)="submitApproval()">Submit</button>
      <button mat-raised-button color="warn" class="submit-btn delete-btn" (click)="cancelApproval()">Cancel</button>
    </mat-dialog-actions>
  </div>

</ng-template>





<!-- <img ngSrc='assets/info1.jpeg' height="450" width="800"> -->
