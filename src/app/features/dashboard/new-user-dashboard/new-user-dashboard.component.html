<div *ngIf="isLoading">
  <app-loader></app-loader>
</div>

<div class="dashboard-grid">
  <!-- Welcome / CTA -->
  <section class="card welcome-card">
    <mat-card>
      <mat-card-header>
        <mat-card-title>Welcome to Your ProBuildAI Dashboard</mat-card-title>
      </mat-card-header>
      <mat-card-content>
        <div *ngIf="teams.length > 1" class="team-picker">
          <mat-form-field appearance="outline">
            <mat-label>Select Team</mat-label>
            <mat-select [(ngModel)]="selectedTeam" name="team">
              <mat-option *ngFor="let team of teams" [value]="team">{{ team.inviterName }}</mat-option>
            </mat-select>
          </mat-form-field>
        </div>

        <mat-divider class="section-divider"></mat-divider>

        <p class="welcome-text" *ngIf="isSubContractor">
          As a {{userType}}, manage your construction projects efficiently with our comprehensive tools.
          Track progress, create job quotes, and stay organized all in one place.
        </p>
        <p class="welcome-text" *ngIf="!isSubContractor">
          Welcome to ProBuildAI! Explore our tools to streamline your project management needs.
        </p>

        <div class="actions">
          <button class="btn-primary" mat-flat-button (click)="navigateToJobs()">View & Create Jobs</button>
        </div>
      </mat-card-content>
    </mat-card>
  </section>

  <!-- Action Points -->
  <section class="card action-points-card">
    <mat-card>
      <mat-card-header>
        <mat-card-title><strong>Action Points</strong></mat-card-title>
      </mat-card-header>
      <mat-card-content>
        <mat-divider class="section-divider"></mat-divider>

        <p *ngIf="notes.length === 0" class="muted">No notes assigned to you yet.</p>

        <div class="table-wrap" *ngIf="notes.length > 0">
          <mat-table [dataSource]="notes" class="job-table">
            <!-- Project Column -->
            <ng-container matColumnDef="project">
              <mat-header-cell *matHeaderCellDef>Project</mat-header-cell>
              <mat-cell *matCellDef="let note" class="wrap">{{ note.projectName }}</mat-cell>
            </ng-container>

            <!-- Task Column -->
            <ng-container matColumnDef="task">
              <mat-header-cell *matHeaderCellDef>Task</mat-header-cell>
              <mat-cell *matCellDef="let note" class="wrap">{{ note.subtaskName }}</mat-cell>
            </ng-container>

            <!-- Created Column -->
            <ng-container matColumnDef="created">
              <mat-header-cell *matHeaderCellDef>Created</mat-header-cell>
              <mat-cell *matCellDef="let note">{{ note.createdAt | date:'short' }}</mat-cell>
            </ng-container>

            <!-- Status Column -->
            <ng-container matColumnDef="status">
              <mat-header-cell *matHeaderCellDef>Status</mat-header-cell>
              <mat-cell *matCellDef="let note">
                <span class="badge"
                      [ngClass]="{
                        'is-archived': note.status === 'Archived',
                        'is-approved': note.status === 'Approved',
                        'is-rejected': note.status === 'Rejected',
                        'is-pending': note.status === 'Pending'
                      }">{{ note.status }}</span>
              </mat-cell>
            </ng-container>

            <!-- Action Column -->
            <ng-container matColumnDef="action">
              <mat-header-cell *matHeaderCellDef>Action</mat-header-cell>
              <mat-cell *matCellDef="let note">
                <button class="btn-primary" mat-button (click)="openNoteDialog(note)"
                        [disabled]="openingNoteId === note.notes[0].id">
                  {{ openingNoteId === note.notes[0].id ? 'Viewing…' : 'View' }}
                </button>
              </mat-cell>
            </ng-container>

            <mat-header-row *matHeaderRowDef="notesDisplayedColumns"></mat-header-row>
            <mat-row *matRowDef="let row; columns: notesDisplayedColumns;"></mat-row>
          </mat-table>
        </div>
      </mat-card-content>
    </mat-card>
  </section>

  <!-- Job Progress -->
  <section class="card job-progress-card">
    <mat-card>
      <mat-card-header>
        <mat-card-title><strong>Project Progress</strong></mat-card-title>
      </mat-card-header>
      <mat-card-content>
        <mat-divider class="section-divider"></mat-divider>

        <p *ngIf="jobsLoading" class="muted">Loading jobs…</p>
        <p *ngIf="!jobsLoading && userJobs.length === 0" class="muted">No jobs assigned to you yet.</p>

        <div class="table-wrap" *ngIf="userJobs.length > 0">
          <mat-table [dataSource]="userJobs" class="job-table">
            <ng-container matColumnDef="project">
              <mat-header-cell *matHeaderCellDef>Project</mat-header-cell>
              <mat-cell *matCellDef="let job">{{ job.projectName }}</mat-cell>
            </ng-container>

            <ng-container matColumnDef="created">
              <mat-header-cell *matHeaderCellDef>Created</mat-header-cell>
              <mat-cell *matCellDef="let job">{{ job.createdAt | date: 'shortDate' }}</mat-cell>
            </ng-container>

            <ng-container matColumnDef="progress">
              <mat-header-cell *matHeaderCellDef>Progress</mat-header-cell>
              <mat-cell *matCellDef="let job">
                <div class="progress">
                  <div class="bar" [style.width.%]="job.progress"></div>
                </div>
                <span class="pct">{{ job.progress }}%</span>
              </mat-cell>
            </ng-container>

            <ng-container matColumnDef="status">
              <mat-header-cell *matHeaderCellDef>Status</mat-header-cell>
              <mat-cell *matCellDef="let job">{{ job.status | titlecase}}</mat-cell>
            </ng-container>

            <ng-container matColumnDef="actions">
              <mat-header-cell *matHeaderCellDef></mat-header-cell>
              <mat-cell *matCellDef="let job">
                <button mat-icon-button [matMenuTriggerFor]="jobMenu">
                  <mat-icon>more_vert</mat-icon>
                </button>
                <mat-menu #jobMenu="matMenu">
                  <button mat-menu-item (click)="loadJob(job.id)">View Job</button>
                  <button mat-menu-item [disabled]="job.progress !== 100" (click)="archiveJob(job.id)">
                    Archive Job
                  </button>
                </mat-menu>
              </mat-cell>
            </ng-container>

            <mat-header-row *matHeaderRowDef="jobDisplayedColumns"></mat-header-row>
            <mat-row *matRowDef="let row; columns: jobDisplayedColumns;"></mat-row>
          </mat-table>
        </div>
      </mat-card-content>
    </mat-card>
  </section>
</div>

<!-- Documents Dialog -->
<ng-template #documentsDialog>
  <div class="documents-dialog">
    <h2 mat-dialog-title>Quote Documents</h2>
    <mat-dialog-content>
      <!-- Show loading indicator while fetching documents -->
      <div *ngIf="isDocumentsLoading" class="loading-documents">
        <app-loader></app-loader>
        <p>Loading documents...</p>
      </div>
      <!-- Show content only when not loading -->
      <div *ngIf="!isDocumentsLoading">
        <div *ngIf="documents.length === 0 && !documentsError" class="no-documents">
          <p>No documents available for this quote.</p>
        </div>
        <div *ngIf="documentsError" class="no-documents">
          <p>{{documentsError}}</p>
        </div>
        <div *ngIf="documents.length > 0" class="documents-list">
          <div class="document-item" *ngFor="let doc of documents; let i = index">
            <div class="document-info">
              <span class="document-name">{{doc.name}}</span>
              <span class="document-meta">{{doc.type}} - {{doc.size | filesize}}</span>
            </div>
            <button class="view-btn" mat-raised-button (click)="viewDocument(doc)">
              View
            </button>
          </div>
        </div>
      </div>
    </mat-dialog-content>
    <mat-dialog-actions>
      <button class="submit-btn" mat-raised-button (click)="closeDocumentsDialog()">Close</button>
    </mat-dialog-actions>
  </div>
</ng-template>

<!-- Approval Reason Dialog -->
<ng-template #approvalReasonDialog>
  <div class="note-detail-dialog">
    <h2 mat-dialog-title>Approval Reason</h2>

    <mat-dialog-content>
      <div
        class="note-text-box"
        contenteditable="true"
        (input)="onApprovalReasonChanged($event)"
        placeholder="Enter your approval reason here...">
      </div>
    </mat-dialog-content>

    <mat-dialog-actions align="end">
      <button mat-raised-button color="primary" class="submit-btn delete-btn" (click)="submitApproval()">Submit</button>
      <button mat-raised-button color="warn" class="submit-btn delete-btn" (click)="cancelApproval()">Cancel</button>
    </mat-dialog-actions>
  </div>

</ng-template>

<!-- <img ngSrc='assets/info1.jpeg' height="450" width="800"> -->
