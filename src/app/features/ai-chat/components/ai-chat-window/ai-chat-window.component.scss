@use 'styles/util/mixins' as u;


@keyframes pulse-text {
  0% { opacity: .55; } 50% { opacity: 1; } 100% { opacity: .55; }
}

:host {
  position: fixed;
  bottom: 20px;
  right: 20px;
  z-index: 1000;
}

/* Window */
.chat-window {
  width: 500px;
  height: 600px;
  min-width: 300px;
  min-height: 400px;
  max-width: 80vw;
  max-height: 90vh;

  background: var(--color-surface);
  color: var(--color-text);
  border: 1px solid var(--color-border);
  border-radius: var(--radius-lg);
  box-shadow: var(--shadow-3);

  display: flex;
  flex-direction: column-reverse; /* newest at bottom */
  overflow: auto;
  resize: both;
  direction: rtl;
  transform: rotateX(180deg);
}
.chat-window > * {
  direction: ltr;
  transform: rotateX(180deg);
}

/* Header */
.chat-header {
  display: flex; align-items: center; justify-content: space-between;
  padding: .75rem 1rem;
  background: var(--color-primary);
  color: var(--color-text-inverse);
  border-top-left-radius: var(--radius-lg);
  border-top-right-radius: var(--radius-lg);

  .chat-title {
    margin: 0; font-size: 1.1rem; font-weight: var(--fw-semibold);
    letter-spacing: .015em;
  }

  .header-actions { display: inline-flex; gap: .5rem; }

  .action-btn {
    background: transparent; border: 0; padding: 6px; cursor: pointer;
    color: var(--color-text-inverse);
    border-radius: var(--radius-sm);
    @include u.interactive-states;

    .material-icons { font-size: 20px; }
    &:hover { background: color-mix(in oklab, var(--color-primary) 18%, transparent); }
    &:focus-visible { outline: 0; box-shadow: 0 0 0 2px color-mix(in oklab, var(--color-text-inverse) 65%, transparent); }
  }
}

/* Scroll frame */
.scroll-wrapper { flex: 1; position: relative; }
.chat-window-container {
  position: absolute; inset: 0;
  overflow-y: auto;
  padding: 1rem;
}

/* Messages */
.message-history {
  display: flex; flex-direction: column; gap: .5rem;

  .message {
    display: flex; align-items: flex-start; gap: .75rem;
    padding: .5rem 1rem;
    border-radius: 16px;
    margin-bottom: .25rem;
    max-width: 80%;
    box-shadow: 0 1px 2px rgba(0,0,0,.06);

    .chat-icon {
      flex-shrink: 0;
      background: var(--color-primary);
      color: var(--color-text-inverse);
      border-radius: 12px;
      font-size: 18px; padding: 3px;
    }

    .message-content {
      flex: 1;
      word-wrap: break-word;
      white-space: pre-wrap;
    }

    &.user-message {
      align-self: flex-end;
      background: var(--color-primary);
      color: var(--color-text-inverse) !important;
      border-bottom-right-radius: 6px;
    }

    &.ai-message {
      align-self: flex-start;
      background: var(--color-surface);
      color: var(--color-text);
      border: 1px solid var(--color-border);
      border-bottom-left-radius: 6px;
    }

    &.ai p { animation: pulse-text 1.5s infinite; }
  }

  .user-prompt {
    color: var(--color-text-inverse) !important;
    font: inherit;
    white-space: pre-wrap;
    word-wrap: break-word;
  }
}

/* Composer */
.message-input-container {
  flex-shrink: 0;
  padding: .75rem 1rem;
  background: var(--color-surface);
  border-top: 1px solid var(--color-border);
  position: relative;

  form {
    display: flex; align-items: center; gap: .5rem;

    input, textarea {
      flex: 1;
      background: var(--color-surface);
      color: var(--color-text);
      border: 1px solid var(--color-border);
      border-radius: 20px;
      padding: .6rem .9rem;
      font-size: .95rem;
      resize: none; overflow-y: hidden;
      transition: border-color .15s ease, box-shadow .15s ease;

      &:focus { outline: 0; border-color: var(--color-primary);
        box-shadow: 0 0 0 3px color-mix(in oklab, var(--color-primary) 22%, transparent); }
      &:disabled { cursor: not-allowed; }
    }

    button { gap: .25rem; margin-right: .1rem; min-width: auto; padding: 6px 12px; font-size: .9rem; }

    /* Icon submit */
    button.action-btn.submit-btn {
      padding: 0; min-width: 40px; width: 40px; height: 40px;
      display: inline-flex; align-items: center; justify-content: center;
      border-radius: 10px;
      background: var(--color-primary);
      color: var(--color-text-inverse);
      @include u.interactive-states;

      .mat-icon { margin: 0; }
      &:hover { background: var(--color-primary-hover); }
    }
  }
}

.upload-progress, .upload-complete {
  margin-bottom: .5rem;
  p { margin: 0; font-size: .85rem; }
}
.upload-progress p { color: var(--color-text); }
.upload-complete p { color: var(--color-success); }

.submit-btn {
  background: var(--color-primary);
  color: var(--color-text-inverse);
  border: 0;
  border-radius: var(--radius-md);
  padding: 8px 16px;
  font-weight: var(--fw-semibold);
  @include u.interactive-states;

  &:hover { background: var(--color-primary-hover); }
  &.publish-btn { background: var(--color-primary); }
}
.send-button[disabled] { background: #ccc; cursor: not-allowed; }

/* More options icon next to composer */
.more-options-btn {
  background: transparent; border: 0; color: var(--color-text);
  font-size: 1.2rem; padding: 0 .5rem; cursor: pointer; border-radius: var(--radius-sm);
  @include u.interactive-states;

  &:hover { color: var(--color-primary); background: var(--color-surface-subtle); }
}

/* Prompts popup */
.prompts-popup {
  position: absolute; top: 80px; left: 1rem; z-index: 100;
  width: calc(100% - 2rem);
  max-height: 220px; overflow-y: auto;

  background: var(--color-surface);
  border: 1px solid var(--color-border);
  border-radius: var(--radius-md);
  box-shadow: var(--shadow-2, 0 8px 24px rgba(0,0,0,.08));
  padding: .5rem;

  .prompt-item {
    padding: .5rem;
    border-bottom: 1px solid var(--color-border);
    cursor: pointer;
    border-radius: var(--radius-sm);
    transition: background-color .15s ease;

    &:hover { background: var(--color-surface-hover); }

    .prompt-title { font-weight: var(--fw-bold); color: var(--color-text); font-size: .95rem; }
    .prompt-description { font-size: .85rem; color: var(--color-text-muted); margin-top: .25rem; }
  }
}

/* Slide-over history panel */
.chat-history-panel {
  position: absolute; inset: 0;
  background: var(--color-canvas);
  z-index: 10;
  padding: 1rem;
  border-top: 1px solid var(--color-border);
  overflow-y: auto;

  .history-header {
    display: flex; align-items: center; justify-content: space-between;
    margin-bottom: .5rem;

    h3 { margin: 0; color: var(--color-text); }

    .action-btn {
      background: transparent; border: 0; padding: 6px; cursor: pointer;
      color: var(--color-text); border-radius: var(--radius-sm);
      @include u.interactive-states;
      .material-icons { font-size: 20px; }
      &:hover { background: var(--color-surface-subtle); color: var(--color-accent); }
    }
  }

  ul { list-style: none; margin: 0; padding: 0; }

  li {
    display: flex; align-items: center; justify-content: space-between;
    padding: .75rem;
    border-bottom: 1px solid var(--color-border);
    cursor: pointer; transition: background-color .15s ease; border-radius: var(--radius-sm);

    &:hover { background: var(--color-surface-hover); }
  }
}

/* Sticky selected prompt card */
.selected-prompt-display {
  position: sticky; top: 0; z-index: 2;
  background: var(--color-surface-subtle);
  padding: .75rem; margin-bottom: 1rem;
  border: 1px solid var(--color-border);
  border-radius: var(--radius-md);

  h2 { margin: 0; font-size: 1rem; font-weight: var(--fw-semibold); color: var(--color-text); }
  ul { list-style: none; margin: 0; padding: 0; }
  li { margin-bottom: .5rem; font-size: .9rem; color: var(--color-text-muted); word-wrap: break-word; }
}

/* Utility */
.button-wrapper { display: inline-block; }
.disabled-wrapper { cursor: not-allowed; }
.disabled-wrapper .submit-btn { background: #ccc; color: #666; pointer-events: none; }

.icon-button {
  min-width: 0; padding: 0; width: 40px; height: 40px;
  display: inline-flex; align-items: center; justify-content: center;
  border-radius: var(--radius-sm);
  @include u.interactive-states;

  .mat-icon { margin: 0; }
}

/* Form gap fallback */
form { display: flex; gap: 1px; }

@media (max-width: 560px) {
  .chat-window { width: 94vw; height: 70vh; }
}
@media (prefers-reduced-motion: reduce) {
  * { animation: none !important; transition: none !important; }
}
