<div class="full-screen-chat-container">
  <!-- Left Column: Conversation List -->
  <div class="conversations-list">
    <button mat-raised-button color="primary" class="new-chat-btn submit-btn publish-btn" (click)="startNewConversation()">+ New Chat</button>
    <div class="conversation-items">
      <div *ngFor="let conversation of conversations$ | async"
           class="conversation-item"
           [class.active]="(currentConversation$ | async)?.Id === conversation.Id"
           (click)="selectConversation(conversation.Id)">
        <div class="conversation-title-container">
          <ng-container *ngIf="editingConversationId !== conversation.Id; else editMode">
            <p class="conversation-title">{{ conversation.Title }}</p>
            <mat-icon class="edit-icon" (click)="startEditing(conversation)">edit</mat-icon>
          </ng-container>
          <ng-template #editMode>
            <div class="edit-container">
              <input type="text" [(ngModel)]="editedTitle" (keyup.enter)="saveTitle()" class="edit-input" />
              <div class="edit-actions">
                <button mat-icon-button class="save-button" (click)="saveTitle()">
                  <mat-icon>check</mat-icon>
                </button>
                <button mat-icon-button class="cancel-button" (click)="cancelEditing()">
                  <mat-icon>close</mat-icon>
                </button>
              </div>
            </div>
          </ng-template>
        </div>
        <p class="conversation-excerpt">{{ conversation.ConversationSummary }}</p>
      </div>
    </div>
  </div>

  <!-- Right Column: Chat Area -->
  <div class="chat-area">
    <ng-container *ngIf="(chatView$ | async) === 'prompt-selection'; else chatWindow">
      <div class="welcome-screen">
        <h2>Welcome to Mason - your ProBuild AI Chatbot</h2>
        <p>Select a conversation or start a new one.</p>
        <div class="prompt-selection" *ngIf="(prompts$ | async) as prompts">
            <div *ngIf="prompts.length > 0; else noPrompts">
                <h3>Start a new chat with a prompt:</h3>
                <div class="prompt-buttons">
                    <ng-container *ngFor="let prompt of prompts">
                       <button mat-raised-button class="submit-btn publish-btn" (click)="startConversationWithPrompt(prompt)">
                           {{ prompt.displayName }}
                       </button>
                   </ng-container>
                   <button mat-raised-button class="submit-btn publish-btn" (click)="renovationAnalysisInput.click()">
                       Renovation Analysis
                   </button>
                   <input type="file" #renovationAnalysisInput style="display: none" (change)="onFileSelected($event, 'renovation')" multiple />
                   <button mat-raised-button class="submit-btn publish-btn" (click)="subcontractorComparisonInput.click()">
                       Subcontractor Comparison
                   </button>
                   <input type="file" #subcontractorComparisonInput style="display: none" (change)="onFileSelected($event, 'subcontractor')" multiple />
                   <button mat-raised-button class="submit-btn publish-btn" (click)="vendorComparisonInput.click()">
                       Vendor Comparison
                   </button>
                   <input type="file" #vendorComparisonInput style="display: none" (change)="onFileSelected($event, 'vendor')" multiple />
                </div>
            </div>
            <ng-template #noPrompts>
                <p>Click "New Chat" to get started.</p>
            </ng-template>
        </div>
      </div>
    </ng-container>
    <ng-template #chatWindow>
      <div class="chat-window-container">
        <header class="chat-header">
          <div class="prompt-info">
            <h2 class="chat-title">{{ (selectedPrompt$ | async)?.displayName }}</h2>
            <mat-icon [matTooltip]="(selectedPrompt$ | async)?.description">info_outline</mat-icon>
          </div>
        </header>
        <div class="message-history">
          <div *ngFor="let message of messages$ | async" class="message" [ngClass]="{ 'user-message': message.Role === 'user', 'ai-message': message.Role === 'model' }">
            <mat-icon class="chat-icon">{{ message.Role === 'user' ? 'person' : 'smart_toy' }}</mat-icon>
            <div class="message-content">
              <ng-container [ngSwitch]="message.Role">
                <markdown *ngSwitchCase="'model'" [data]="getDisplayContent(message.Content, 'model')"></markdown>
                <pre *ngSwitchCase="'user'" class="user-prompt">{{ getDisplayContent(message.Content, 'user') }}</pre>
              </ng-container>
            </div>
          </div>
          <div *ngIf="isLoading$ | async" class="message ai">
            <p>Thinking...</p>
          </div>
        </div>
        <div class="message-input-container">
         <div *ngIf="isUploading" class="upload-progress">
           <p>Upload Progress: {{ progress }}%</p>
           <mat-progress-bar mode="determinate" [value]="progress"></mat-progress-bar>
         </div>
         <div *ngIf="!isUploading && uploadedFileInfos.length > 0" class="upload-complete">
           <p [matTooltip]="getUploadedFileNames()" matTooltipPosition="above">
             {{ uploadedFileInfos.length }} file(s) uploaded successfully
           </p>
         </div>
          <form (ngSubmit)="sendMessage()">
            <input type="text"
                   [(ngModel)]="newMessageContent"
                   name="newMessageContent"
                   placeholder="Type your message..."
                   autocomplete="off">
            <button mat-raised-button type="button" class="action-btn submit-btn publish-btn" (click)="onAttachFile()">
            <mat-icon>attach_file</mat-icon>
            </button>
            <button mat-raised-button type="button" class="action-btn submit-btn publish-btn" (click)="viewUploadedFiles()">
            <mat-icon>folder</mat-icon>
            </button>
            <input type="file" #fileInput style="display: none" (change)="onFileSelected($event)" multiple />
            <input type="file" #folderInput style="display: none" (change)="onFileSelected($event)" webkitdirectory multiple />
            <button mat-raised-button color="primary" type="submit" class="submit-btn publish-btn" [disabled]="!newMessageContent.trim()">Send</button>
          </form>
        </div>
      </div>
    </ng-template>
  </div>
</div>
